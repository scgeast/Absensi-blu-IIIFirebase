
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Attendance Crew CDC East</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

<style>
:root {
--primary-color: #2a2d43;
--secondary-color: #4a5079;
--accent-color: #7b89c9;
--highlight-color: #a6b1e8;
--text-color: #e4e8f0;
--sidebar-width: 250px;
--sidebar-collapsed-width: 70px;
}

* {
box-sizing: border-box;
}

body {
background-color: #f8f9fa;
font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
margin: 0;
padding: 0;
transition: all 0.3s ease;
overflow-x: hidden;
}

/* Login Styles - Responsive */
.login-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
display: flex;
justify-content: center;
align-items: center;
z-index: 2000;
padding: 20px;
}

.login-form {
background-color: white;
padding: 25px;
border-radius: 10px;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
width: 100%;
max-width: 400px;
}

.login-title {
text-align: center;
margin-bottom: 20px;
color: var(--primary-color);
font-weight: bold;
font-size: clamp(1.3rem, 4vw, 1.5rem);
}

.login-error {
color: #dc3545;
font-size: 0.9rem;
margin-top: 5px;
display: none;
}

.form-control {
border-radius: 5px;
border: 1px solid #ced4da;
padding: 10px 15px;
font-size: 1rem;
transition: border-color 0.15s ease-in-out, box-shadow 0.15s ease-in-out;
}

.form-control:focus {
border-color: var(--accent-color);
box-shadow: 0 0 0 0.25rem rgba(123, 137, 201, 0.25);
}

/* Connection Status - Mobile Friendly */
.connection-status {
position: fixed;
top: 10px;
right: 10px;
padding: 8px 15px;
border-radius: 20px;
font-size: 0.8rem;
font-weight: bold;
z-index: 3000;
display: none;
max-width: 120px;
text-overflow: ellipsis;
overflow: hidden;
white-space: nowrap;
}

.connection-online {
background-color: #28a745;
color: white;
}

.connection-offline {
background-color: #dc3545;
color: white;
}

/* Header Styles - Responsive */
.futuristic-header {
background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
color: var(--text-color);
padding: clamp(10px, 3vw, 20px) 0;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
border-bottom: 2px solid var(--accent-color);
position: relative;
overflow: hidden;
margin-left: var(--sidebar-collapsed-width);
transition: margin-left 0.3s;
display: none;
}

.header-expanded .futuristic-header {
margin-left: var(--sidebar-width);
}

.futuristic-header::before {
content: '';
position: absolute;
top: 0;
left: 0;
right: 0;
height: 2px;
background: linear-gradient(90deg, transparent, var(--highlight-color), transparent);
animation: shimmer 3s infinite;
}

@keyframes shimmer {
0% { background-position: -200% 0; }
100% { background-position: 200% 0; }
}

.header-title {
font-size: clamp(1.5rem, 5vw, 2.5rem);
font-weight: 700;
text-transform: uppercase;
letter-spacing: 1px;
text-shadow: 0 0 10px rgba(166, 177, 232, 0.5);
margin: 0;
word-wrap: break-word;
line-height: 1.2;
}

.header-subtitle {
font-size: clamp(0.8rem, 2.5vw, 1rem);
opacity: 0.8;
margin-top: 5px;
}

/* Sidebar Styles - Mobile Optimized */
.sidebar {
position: fixed;
top: 0;
left: 0;
height: 100%;
width: var(--sidebar-collapsed-width);
background: linear-gradient(to bottom, var(--primary-color), var(--secondary-color));
color: var(--text-color);
transition: all 0.3s ease;
z-index: 1000;
overflow-y: auto;
box-shadow: 2px 0 10px rgba(0, 0, 0, 0.2);
display: none;
}

.sidebar.expanded {
width: var(--sidebar-width);
}

.sidebar-header {
padding: 20px 15px;
border-bottom: 1px solid rgba(255, 255, 255, 0.1);
display: flex;
align-items: center;
justify-content: space-between;
}

.sidebar-header h3 {
margin: 0;
font-size: 1.2rem;
white-space: nowrap;
overflow: hidden;
display: none;
}

.sidebar.expanded .sidebar-header h3 {
display: block;
}

.sidebar-toggle {
background: none;
border: none;
color: var(--text-color);
font-size: 1.2rem;
cursor: pointer;
padding: 5px;
}

.sidebar-menu {
list-style: none;
padding: 0;
margin: 0;
}

.sidebar-menu li {
margin: 0;
}

.sidebar-menu a {
display: flex;
align-items: center;
padding: 12px 15px;
color: var(--text-color);
text-decoration: none;
transition: background-color 0.3s;
white-space: nowrap;
overflow: hidden;
}

.sidebar-menu a:hover {
background-color: rgba(255, 255, 255, 0.1);
}

.sidebar-menu a.active {
background-color: var(--accent-color);
}

.sidebar-menu i {
margin-right: 0;
width: 20px;
text-align: center;
font-size: 1.1rem;
}

.sidebar.expanded .sidebar-menu i {
margin-right: 10px;
}

.sidebar-menu span {
display: none;
}

.sidebar.expanded .sidebar-menu span {
display: inline;
}

.sidebar-folder {
margin-bottom: 10px;
}

.sidebar-folder-header {
display: flex;
align-items: center;
padding: 10px 15px;
color: var(--text-color);
cursor: pointer;
font-weight: bold;
transition: background-color 0.3s;
}

.sidebar-folder-header:hover {
background-color: rgba(255, 255, 255, 0.1);
}

.sidebar-folder-header i {
margin-right: 10px;
transition: transform 0.3s;
}

.sidebar-folder.expanded .sidebar-folder-header i {
transform: rotate(90deg);
}

.sidebar-folder-content {
display: none;
padding-left: 25px;
}

.sidebar-folder.expanded .sidebar-folder-content {
display: block;
}

/* Main Content - Responsive */
.main-content {
margin-left: var(--sidebar-collapsed-width);
transition: margin-left 0.3s;
padding: 15px;
display: none;
}

.main-content.expanded {
margin-left: var(--sidebar-width);
}

/* User Password Section - Mobile Hidden */
.user-password-section {
position: fixed;
bottom: 0;
left: 0;
width: var(--sidebar-collapsed-width);
background-color: rgba(0, 0, 0, 0.2);
padding: 15px;
transition: width 0.3s;
z-index: 1001;
display: none;
}

.sidebar.expanded + .user-password-section {
width: var(--sidebar-width);
}

.user-password-section.expanded {
width: var(--sidebar-width);
}

.user-password-btn {
width: 100%;
background: none;
border: 1px solid var(--text-color);
color: var(--text-color);
padding: 8px;
border-radius: 5px;
cursor: pointer;
transition: all 0.3s;
display: flex;
align-items: center;
justify-content: center;
font-size: 0.9rem;
}

.user-password-btn:hover {
background-color: rgba(255, 255, 255, 0.1);
}

.user-password-btn i {
margin-right: 0;
}

.user-password-section.expanded .user-password-btn i {
margin-right: 8px;
}

.user-password-section.expanded .user-password-btn span {
display: inline;
}

.user-password-btn span {
display: none;
}

/* Filter Section - Mobile Friendly */
.filter-section {
background-color: white;
padding: 15px;
border-radius: 8px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
margin-bottom: 15px;
}

.filter-section .row {
margin: -5px;
}

.filter-section .col-md-4,
.filter-section .col-md-3,
.filter-section .col-md-6 {
padding: 5px;
margin-bottom: 10px;
}

/* Tab Styles - Mobile Friendly */
.nav-tabs {
background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
border-radius: 5px;
padding: 3px;
margin-bottom: 15px;
overflow-x: auto;
white-space: nowrap;
display: flex;
flex-wrap: nowrap;
-webkit-overflow-scrolling: touch;
}

.nav-link {
color: var(--text-color);
border: none;
border-radius: 5px;
margin: 0 1px;
transition: all 0.3s;
padding: 8px 12px;
font-size: 0.85rem;
white-space: nowrap;
flex-shrink: 0;
}

.nav-link:hover, .nav-link.active {
background-color: var(--highlight-color);
color: var(--primary-color);
transform: translateY(-1px);
}

.btn-futuristic {
background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
color: white;
border: none;
border-radius: 5px;
padding: 8px 12px;
transition: all 0.3s;
font-size: 0.9rem;
white-space: nowrap;
}

.btn-futuristic:hover {
background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
transform: translateY(-1px);
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
color: white;
}

/* Table Styles - Mobile Optimized */
.table-container {
overflow-x: auto;
width: 100%;
max-height: 500px;
margin-bottom: 15px;
border: 1px solid #dee2e6;
border-radius: 5px;
-webkit-overflow-scrolling: touch;
}

table {
width: auto;
min-width: 100%;
border-collapse: collapse;
background-color: white;
}

th, td {
padding: 4px 6px;
text-align: center;
border: 1px solid #dee2e6;
word-wrap: break-word;
overflow-wrap: break-word;
font-size: 0.75rem;
background-color: white;
height: 35px;
min-width: 60px;
max-width: 100px;
}

th {
background-color: var(--secondary-color);
color: white;
position: sticky;
top: 0;
font-weight: bold;
font-size: 0.7rem;
padding: 4px 4px;
}

input[type="text"] {
width: 100%;
border: none;
text-align: center;
background: transparent;
padding: 3px;
font-size: 0.75rem;
}

input[type="text"]:focus {
outline: none;
background-color: #f8f9fa;
}

/* PERBAIKAN: Navigasi keyboard untuk tabel */
.editable-cell:focus {
outline: 2px solid var(--accent-color);
outline-offset: -2px;
background-color: #f8f9fa;
}

/* Warna yang lebih jelas untuk setiap shift */
.shift-1 { background-color: #4CAF50; color: white; } /* Pagi - Hijau */
.shift-2 { background-color: #FFC107; color: black; } /* Siang - Kuning */
.shift-3 { background-color: #2196F3; color: white; } /* Malam - Biru */
.shift-11 { background-color: #8BC34A; color: white; } /* Pjk Pagi - Hijau muda */
.shift-22 { background-color: #FF9800; color: white; } /* Pjk Siang - Jingga */
.shift-C { background-color: #9E9E9E; color: white; } /* Cuti - Abu-abu */
.shift-O { background-color: #F44336; color: white; } /* Off - Merah */

.legend {
display: flex;
flex-wrap: wrap;
gap: 8px;
margin-bottom: 10px;
justify-content: center;
}

.legend-item {
display: flex;
align-items: center;
gap: 3px;
padding: 3px 6px;
border-radius: 3px;
font-weight: bold;
font-size: 0.7rem;
flex: 1;
min-width: 100px;
max-width: 120px;
}

.legend-color {
width: 12px;
height: 12px;
border-radius: 2px;
flex-shrink: 0;
}

/* Tab Content */
.tab-content {
padding: 15px;
background-color: white;
border-radius: 8px;
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
min-height: 300px;
}

/* Button Styles */
.btn-delete {
background-color: #dc3545;
color: white;
border: none;
border-radius: 3px;
padding: 4px 8px;
cursor: pointer;
font-size: 0.8rem;
}

.btn-delete:hover {
background-color: #c82333;
}

.btn-edit {
background-color: #28a745;
color: white;
border: none;
border-radius: 3px;
padding: 4px 8px;
cursor: pointer;
margin-left: 5px;
font-size: 0.8rem;
}

.btn-edit:hover {
background-color: #218838;
}

/* Collapsible Sections - Mobile Friendly */
.collapsible {
background-color: #f8f9fa;
color: #444;
cursor: pointer;
padding: 10px;
width: 100%;
border: none;
text-align: left;
outline: none;
font-size: 0.9rem;
font-weight: bold;
border-radius: 5px;
margin-bottom: 10px;
display: flex;
justify-content: space-between;
align-items: center;
}

.active, .collapsible:hover {
background-color: #e2e3e5;
}

.collapsible-content {
padding: 0 15px;
max-height: 0;
overflow: hidden;
transition: max-height 0.2s ease-out;
background-color: white;
border-radius: 0 0 5px 5px;
}

.collapsible:after {
content: '\002B'; /* Plus sign */
color: #777;
font-weight: bold;
float: right;
margin-left: 5px;
}

.active:after {
content: "\2212"; /* Minus sign */
}

/* Action buttons - Mobile Friendly - PERUBAHAN: Tombol lebih kecil di pojok kiri */
.action-buttons {
margin-top: 15px;
display: flex;
justify-content: flex-start; /* Diubah dari center ke flex-start */
gap: 8px;
flex-wrap: wrap;
}

.action-buttons .btn {
flex: 0; /* Diubah dari flex: 1 */
min-width: auto; /* Diubah dari min-width: 120px */
padding: 6px 12px; /* Mengurangi padding */
font-size: 0.8rem; /* Membuat font lebih kecil */
}

.header-controls {
display: flex;
gap: 8px;
align-items: center;
margin-bottom: 10px;
flex-wrap: wrap;
}

.header-control-group {
display: flex;
align-items: center;
gap: 5px;
flex-wrap: nowrap;
}

.header-control-label {
font-size: 0.8rem;
white-space: nowrap;
}

.header-control-input {
width: 60px;
padding: 4px;
border: 1px solid #ddd;
border-radius: 3px;
font-size: 0.8rem;
}

/* Modal Styles - Mobile Friendly */
.modal-content {
border-radius: 10px;
border: none;
box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
}

.modal-header {
background: linear-gradient(to right, var(--secondary-color), var(--primary-color));
color: white;
border-radius: 10px 10px 0 0;
padding: 15px;
}

/* User Management Styles */
.user-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
}

.user-table th, .user-table td {
padding: 10px;
text-align: left;
border-bottom: 1px solid #ddd;
}

.user-table th {
background-color: var(--secondary-color);
color: white;
font-weight: bold;
}

/* Cuti Styles */
.cuti-form {
margin-bottom: 20px;
padding: 15px;
background-color: #f8f9fa;
border-radius: 5px;
}

/* Cuti Detail Styles */
.cuti-detail-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
}

.cuti-detail-table th, .cuti-detail-table td {
padding: 10px;
text-align: left;
border-bottom: 1px solid #ddd;
}

.cuti-detail-table th {
background-color: var(--secondary-color);
color: white;
font-weight: bold;
}

/* Rekap Lembur Form Styles - MODIFIED */
.overtime-form-container {
background-color: #f8f9fa;
padding: 15px;
border-radius: 8px;
margin-bottom: 20px;
box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.overtime-form-row {
display: flex;
gap: 10px;
margin-bottom: 15px;
flex-wrap: wrap;
}

.overtime-form-group {
flex: 1;
min-width: 150px;
}

.overtime-form-group label {
display: block;
margin-bottom: 5px;
font-weight: 600;
font-size: 0.9rem;
}

.overtime-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
}

.overtime-table th, .overtime-table td {
padding: 8px;
text-align: left;
border: 1px solid #ddd;
font-size: 0.8rem;
}

.overtime-table th {
background-color: var(--secondary-color);
color: white;
font-weight: bold;
white-space: nowrap;
}

.total-overtime-display {
text-align: right;
margin-top: 15px;
padding: 10px;
background-color: #f8f9fa;
border-radius: 5px;
}

.total-overtime-value {
font-size: 1.5rem;
font-weight: bold;
color: #dc3545;
}

.plant-select-container {
display: flex;
flex-direction: column;
gap: 5px;
}

.plant-select {
width: 100%;
padding: 5px;
font-size: 0.8rem;
}

.rekap-lembur-form .form-group {
margin-bottom: 15px;
}

.rekap-lembur-form label {
font-weight: 600;
margin-bottom: 5px;
display: block;
}

.rekap-lembur-form .form-control {
border-radius: 5px;
border: 1px solid #ced4da;
padding: 8px 12px;
}

.rekap-lembur-form .time-inputs {
display: flex;
gap: 10px;
align-items: center;
}

.rekap-lembur-form .time-inputs .form-control {
flex: 1;
}

.rekap-lembur-table {
width: 100%;
border-collapse: collapse;
margin-top: 15px;
}

.rekap-lembur-table th, .rekap-lembur-table td {
padding: 8px;
text-align: left;
border: 1px solid #ddd;
}

.rekap-lembur-table th {
background-color: var(--secondary-color);
color: white;
font-weight: bold;
}

.overtime-detail-table {
width: 100%;
border-collapse: collapse;
margin-top: 20px;
}

.overtime-detail-table th, .overtime-detail-table td {
padding: 8px;
text-align: left;
border: 1px solid #ddd;
}

.overtime-detail-table th {
background-color: var(--secondary-color);
color: white;
font-weight: bold;
}

/* Loading Spinner */
.spinner-container {
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background-color: rgba(0, 0, 0, 0.5);
display: flex;
justify-content: center;
align-items: center;
z-index: 3000;
}

.spinner {
width: 50px;
height: 50px;
border: 5px solid #f3f3f3;
border-top: 5px solid var(--primary-color);
border-radius: 50%;
animation: spin 1s linear infinite;
}

@keyframes spin {
0% { transform: rotate(0deg); }
100% { transform: rotate(360deg); }
}

/* Mobile Menu Toggle */
.mobile-menu-toggle {
display: none;
position: fixed;
top: 15px;
left: 15px;
z-index: 1100;
background: var(--primary-color);
color: white;
border: none;
border-radius: 5px;
padding: 10px 12px;
font-size: 1.2rem;
box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
}

/* Backdrop for mobile sidebar */
.sidebar-backdrop {
display: none;
position: fixed;
top: 0;
left: 0;
width: 100%;
height: 100%;
background: rgba(0, 0, 0, 0.5);
z-index: 999;
}

/* Responsive Styles */
@media (max-width: 1200px) {
th, td {
min-width: 50px;
max-width: 80px;
font-size: 0.7rem;
padding: 3px 4px;
}

.sidebar-menu a {
padding: 10px 12px;
}
}

@media (max-width: 992px) {
.sidebar {
transform: translateX(-100%);
width: var(--sidebar-width);
}

.sidebar.mobile-open {
transform: translateX(0);
}

.mobile-menu-toggle {
display: block;
}

.sidebar-backdrop.mobile-open {
display: block;
}

.main-content {
margin-left: 0;
padding: 10px;
}

.futuristic-header {
margin-left: 0;
padding: 10px 0;
}

.user-password-section {
display: none !important;
}

.tab-content {
padding: 10px;
}
}

@media (max-width: 768px) {
.login-form {
padding: 20px;
margin: 10px;
}

.header-title {
font-size: 1.8rem;
}

.filter-section .col-md-4 {
flex: 0 0 100%;
max-width: 100%;
}

.action-buttons {
flex-direction: column;
}

.action-buttons .btn {
width: 100%;
}

th, td {
min-width: 45px;
max-width: 70px;
font-size: 0.65rem;
padding: 2px 3px;
}

input[type="text"] {
font-size: 0.65rem;
padding: 2px;
}

.table-container {
max-height: 400px;
}

.nav-tabs {
flex-wrap: nowrap;
overflow-x: auto;
}

.nav-link {
padding: 6px 10px;
font-size: 0.8rem;
}

.legend-item {
min-width: 80px;
font-size: 0.6rem;
}

.modal-dialog {
margin: 10px;
max-width: calc(100% - 20px);
}
}

@media (max-width: 576px) {
body {
font-size: 0.9rem;
}

.main-content {
padding: 8px;
}

.filter-section {
padding: 10px;
}

.btn-futuristic {
padding: 6px 10px;
font-size: 0.8rem;
}

.header-controls {
flex-direction: column;
align-items: flex-start;
}

.header-control-group {
width: 100%;
justify-content: space-between;
}

.legend-item {
min-width: 70px;
font-size: 0.6rem;
padding: 2px 4px;
}

th, td {
min-width: 40px;
max-width: 60px;
font-size: 0.6rem;
padding: 1px 2px;
}

.sidebar {
width: 280px;
}

.sidebar-header {
padding: 15px 10px;
}

.sidebar-menu a {
padding: 12px 10px;
}
}

@media (max-width: 400px) {
.login-form {
padding: 15px;
}

.header-title {
font-size: 1.5rem;
}

.sidebar {
width: 100%;
}

.table-container {
max-height: 300px;
}

.nav-link {
padding: 5px 8px;
font-size: 0.75rem;
}
}

/* Touch improvements for mobile devices */
@media (hover: none) and (pointer: coarse) {
.btn-futuristic:active {
transform: scale(0.98);
}

input, select, textarea {
font-size: 16px !important; /* Prevent zoom on iOS */
}

.sidebar-menu a {
padding: 15px 20px;
}

.nav-link {
padding: 10px 12px;
}
}

/* Print styles */
@media print {
.sidebar, .futuristic-header, .filter-section, .action-buttons {
display: none !important;
}

.main-content {
margin-left: 0 !important;
padding: 0 !important;
}

table {
width: 100% !important;
}
}

/* Performance optimizations */
.table-loading {
opacity: 0.6;
pointer-events: none;
}

.virtual-scroll {
will-change: transform;
}

.offline-message {
background-color: #fff3cd;
border: 1px solid #ffeaa7;
color: #856404;
padding: 10px;
border-radius: 5px;
margin-bottom: 15px;
display: none;
}

/* Provider text style */
.provider-text {
text-align: center;
margin-top: 15px;
font-size: 0.8rem;
color: #6c757d;
font-style: italic;
}

/* PERBAIKAN: Notifikasi sukses */
.notification {
position: fixed;
top: 20px;
right: 20px;
padding: 15px 20px;
border-radius: 5px;
color: white;
font-weight: 500;
z-index: 9999;
box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
opacity: 0;
transform: translateY(-20px);
transition: opacity 0.3s, transform 0.3s;
}

.notification.show {
opacity: 1;
transform: translateY(0);
}

.notification.success {
background-color: #28a745;
}

.notification.error {
background-color: #dc3545;
}

.notification.info {
background-color: #17a2b8;
}

/* New styles for output table header */
#outputTable th {
background-color: var(--secondary-color);
color: white;
}

/* Remarks input field */
.remarks-input {
background-color: transparent;
border: 1px solid #ddd;
border-radius: 3px;
padding: 2px 5px;
font-size: 0.75rem;
}

.remarks-input:focus {
outline: none;
border-color: var(--accent-color);
background-color: #f8f9fa;
}

/* Overtime table specific styles */
.overtime-table th, .overtime-table td {
min-width: 80px;
max-width: 150px;
padding: 6px 8px;
font-size: 0.7rem;
}

.overtime-table th:nth-child(10), /* Actual Check In */
.overtime-table th:nth-child(11), /* Actual Check Out */
.overtime-table th:nth-child(12), /* Over Time */
.overtime-table th:nth-child(13), /* Cek RMC */
.overtime-table th:nth-child(14), /* RKP PIC */
.overtime-table th:nth-child(15) { /* Rmc - Shift Check Out */
min-width: 100px;
}

/* Filter sections for different folders */
.filter-section-main {
background-color: #e9ecef;
border-left: 4px solid var(--primary-color);
}

.filter-section-general {
background-color: #e9ecef;
border-left: 4px solid var(--accent-color);
}

/* Styles untuk view leave details */
.view-leave-details {
cursor: pointer;
color: var(--accent-color);
text-decoration: underline;
}

.view-leave-details:hover {
color: var(--primary-color);
}

.leave-detail-modal .table {
font-size: 0.9rem;
}

.leave-detail-modal th {
background-color: var(--secondary-color);
color: white;
}
</style>
</head>
<body>
<!-- Mobile Menu Toggle -->
<button class="mobile-menu-toggle" id="mobileMenuToggle">
<i class="fas fa-bars"></i>
</button>

<!-- Sidebar Backdrop for Mobile -->
<div class="sidebar-backdrop" id="sidebarBackdrop"></div>

<!-- Connection Status -->
<div class="connection-status" id="connectionStatus"></div>

<!-- Loading Spinner -->
<div class="spinner-container" id="loadingSpinner" style="display: none;">
<div class="spinner"></div>
</div>

<!-- Login Screen -->
<div class="login-container" id="loginContainer">
<div class="login-form">
<h2 class="login-title">ATTENDANCE CREW CDC EAST</h2>
<div class="offline-message" id="loginOfflineMessage">
<i class="fas fa-wifi"></i> You are currently offline. Some features may be limited.
</div>
<div class="mb-3">
<label for="email" class="form-label">Email</label>
<input type="email" class="form-control" id="email" placeholder="Enter email">
</div>
<div class="mb-3">
<label for="password" class="form-label">Password</label>
<input type="password" class="form-control" id="password" placeholder="Enter password">
</div>
<div class="login-error" id="loginError">Email or password is incorrect!</div>
<button class="btn btn-futuristic w-100" id="loginBtn">Login</button>
<div class="provider-text">Provide by L23-51Xe</div>
</div>
</div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
<div class="sidebar-header">
<h3>Attendance Menu</h3>
<button class="sidebar-toggle" id="sidebarToggle">
<i class="fas fa-bars"></i>
</button>
</div>

<!-- General Folder (User & Admin) -->
<div class="sidebar-folder" id="generalFolder">
<div class="sidebar-folder-header">
<i class="fas fa-folder"></i>
<span>General</span>
</div>
<div class="sidebar-folder-content">
<ul class="sidebar-menu">
<li>
<a href="#" data-tab="absen-tabel">
<i class="fas fa-table"></i>
<span>Attendance Table</span>
</a>
</li>
<li>
<a href="#" data-tab="form-rekap-lembur">
<i class="fas fa-calculator"></i>
<span>Overtime Form</span>
</a>
</li>
<li>
<a href="#" data-tab="cuti-detail">
<i class="fas fa-calendar-alt"></i>
<span>Leave Detail</span>
</a>
</li>
</ul>
</div>
</div>

<!-- Main Folder (Admin Only) -->
<div class="sidebar-folder" id="mainFolder">
<div class="sidebar-folder-header">
<i class="fas fa-folder"></i>
<span>Main</span>
</div>
<div class="sidebar-folder-content">
<ul class="sidebar-menu">
<li>
<a href="#" data-tab="entry">
<i class="fas fa-pen-to-square"></i>
<span>Attendance Entry</span>
</a>
</li>
<li>
<a href="#" data-tab="output">
<i class="fas fa-file-export"></i>
<span>Attendance Output</span>
</a>
</li>
<li>
<a href="#" data-tab="overtime">
<i class="fas fa-calculator"></i>
<span>Overtime Calculation</span>
</a>
</li>
<li>
<a href="#" data-tab="cuti">
<i class="fas fa-calendar-alt"></i>
<span>Leave Management</span>
</a>
</li>
</ul>
</div>
</div>

<!-- Settings Menu (Admin Only) -->
<ul class="sidebar-menu">
<li>
<a href="#" data-tab="setting">
<i class="fas fa-cog"></i>
<span>Settings</span>
</a>
</li>
<li>
<a href="#" id="logoutBtn">
<i class="fas fa-sign-out-alt"></i>
<span>Logout</span>
</a>
</li>
</ul>
</div>

<!-- User Password Section -->
<div class="user-password-section" id="userPasswordSection">
<button class="user-password-btn" id="changePasswordSidebarBtn">
<i class="fas fa-key"></i>
<span>Change Password</span>
</button>
</div>

<!-- Header -->
<header class="futuristic-header">
<div class="container">
<h1 class="header-title text-center">ATTENDANCE CREW CDC EAST</h1>
<p class="header-subtitle text-center">Modern and Efficient Attendance Management</p>
</div>
</header>

<!-- Main Content -->
<div class="main-content" id="mainContent">
<div class="offline-message" id="appOfflineMessage">
<i class="fas fa-wifi"></i> You are currently offline. Data will be synced when connection is restored.
</div>

<div class="container mt-4">
<!-- Filter Section for Main Folder -->
<div class="filter-section filter-section-main" id="filterSectionMain">
<h6>Main Folder Filter</h6>
<div class="row g-2">
<div class="col-12 col-md-6 col-lg-4">
<label for="dateRangeMain" class="form-label">Date Range</label>
<div class="input-group input-group-sm">
<input type="date" class="form-control" id="startDateMain">
<span class="input-group-text">to</span>
<input type="date" class="form-control" id="endDateMain">
</div>
</div>
<div class="col-12 col-md-6 col-lg-4" id="employeeFilterContainerMain">
<label for="employeeNameMain" class="form-label">Employee Name</label>
<select class="form-select form-select-sm" id="employeeNameMain">
<option value="all">Select All</option>
<!-- Options will be filled by JavaScript -->
</select>
</div>
<div class="col-12 col-lg-4 d-flex align-items-end gap-2">
<button class="btn btn-futuristic btn-sm flex-fill" id="applyFilterMain">
<i class="fas fa-filter me-1"></i> Apply
</button>
<button class="btn btn-futuristic btn-sm flex-fill" id="exportExcelMain">
<i class="fas fa-file-excel me-1"></i> Export
</button>
</div>
</div>
</div>

<!-- Filter Section for General Folder -->
<div class="filter-section filter-section-general" id="filterSectionGeneral" style="display: none;">
<h6>General Folder Filter</h6>
<div class="row g-2">
<div class="col-12 col-md-6 col-lg-4">
<label for="dateRangeGeneral" class="form-label">Date Range</label>
<div class="input-group input-group-sm">
<input type="date" class="form-control" id="startDateGeneral">
<span class="input-group-text">to</span>
<input type="date" class="form-control" id="endDateGeneral">
</div>
</div>
<div class="col-12 col-md-6 col-lg-4" id="employeeFilterContainerGeneral">
<label for="employeeNameGeneral" class="form-label">Employee Name</label>
<select class="form-select form-select-sm" id="employeeNameGeneral">
<option value="all">Select All</option>
<!-- Options will be filled by JavaScript -->
</select>
</div>
<div class="col-12 col-lg-4 d-flex align-items-end gap-2">
<button class="btn btn-futuristic btn-sm flex-fill" id="applyFilterGeneral">
<i class="fas fa-filter me-1"></i> Apply
</button>
<button class="btn btn-futuristic btn-sm flex-fill" id="exportExcelGeneral">
<i class="fas fa-file-excel me-1"></i> Export
</button>
</div>
</div>
</div>

<!-- Tab Content -->
<div class="tab-content" id="absensiTabContent">
<!-- Entry Tab -->
<div class="tab-pane fade show active" id="entry" role="tabpanel">
<button type="button" class="collapsible">Attendance Entry Form <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Enter shift code (1, 2, 3, 11, 22, C, O) to fill cells and see colors according to shift type.</p>

<div class="legend">
<div class="legend-item shift-1">
<div class="legend-color"></div>
<span>Morning (1)</span>
</div>
<div class="legend-item shift-2">
<div class="legend-color"></div>
<span>Afternoon (2)</span>
</div>
<div class="legend-item shift-3">
<div class="legend-color"></div>
<span>Night (3)</span>
</div>
<div class="legend-item shift-11">
<div class="legend-color"></div>
<span>Morning Part (11)</span>
</div>
<div class="legend-item shift-22">
<div class="legend-color"></div>
<span>Afternoon Part (22)</span>
</div>
<div class="legend-item shift-C">
<div class="legend-color"></div>
<span>Leave (C)</span>
</div>
<div class="legend-item shift-O">
<div class="legend-color"></div>
<span>Off (O)</span>
</div>
</div>

<div class="header-controls">
<div class="header-control-group">
<span class="header-control-label">Header Width:</span>
<input type="number" id="headerWidth" class="header-control-input" placeholder="px" min="60" max="150" value="90">
</div>
<div class="header-control-group">
<span class="header-control-label">Header Height:</span>
<input type="number" id="headerHeight" class="header-control-input" placeholder="px" min="30" max="60" value="35">
</div>
<button class="btn btn-futuristic btn-sm" id="applyHeaderSize">
<i class="fas fa-check me-1"></i> Apply
</button>
</div>
</div>

<div class="table-container">
<table id="entryTable">
<thead>
<tr>
<th>Work Area</th>
<th>Employee Name</th>
<th>Job Position</th>
<!-- Date columns will be filled by JavaScript -->
<th>Action</th>
</tr>
</thead>
<tbody>
<!-- Data will be filled by JavaScript -->
</tbody>
</table>
</div>

<div class="action-buttons">
<button class="btn btn-futuristic" id="addRow">
<i class="fas fa-plus me-1"></i> Add Row
</button>
<button class="btn btn-futuristic" id="saveData">
<i class="fas fa-save me-1"></i> Save
</button>
</div>
</div>

<!-- Output Tab -->
<div class="tab-pane fade" id="output" role="tabpanel">
<button type="button" class="collapsible">Attendance Output Data <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Attendance data that has been input will appear here with appropriate shift check in/out.</p>
</div>

<div class="table-responsive">
<table id="outputTable" class="table table-striped table-sm">
<thead>
<tr>
<th>Work Area</th>
<th>Employee Name</th>
<th>Job Position</th>
<th>Date</th>
<th>Shift</th>
<th>Shift Check In</th>
<th>Shift Check Out</th>
<th>Remarks</th>
</tr>
</thead>
<tbody>
<!-- Data will be filled by JavaScript -->
</tbody>
</table>
</div>

<div class="action-buttons">
<button class="btn btn-futuristic" id="saveOutputData">
<i class="fas fa-save me-1"></i> Save Output
</button>
</div>
</div>

<!-- Overtime Tab -->
<div class="tab-pane fade" id="overtime" role="tabpanel">
<button type="button" class="collapsible">Overtime Calculation <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Here you can manage employee overtime calculation.</p>
</div>

<div class="table-responsive">
<table class="overtime-table table-striped table-sm" id="overtimeTable">
<thead>
<tr>
<th>No</th>
<th>Work Area</th>
<th>Employee Name</th>
<th>Job Position</th>
<th>Date</th>
<th>Shift</th>
<th>Shift Check In</th>
<th>Shift Check Out</th>
<th>WT/Normal</th>
<th>Actual Check In</th>
<th>Actual Check Out</th>
<th>Over Time</th>
<th>Cek RMC</th>
<th>RKP PIC</th>
<th>Rmc - Shift Check Out</th>
<th>Remarks</th>
</tr>
</thead>
<tbody id="overtimeTableBody">
<!-- Data will be filled by JavaScript -->
</tbody>
</table>
</div>

<div class="action-buttons">
<button class="btn btn-futuristic" id="saveOvertimeData">
<i class="fas fa-save me-1"></i> Save Overtime
</button>
</div>
</div>

<!-- Absen Tabel Tab -->
<div class="tab-pane fade" id="absen-tabel" role="tabpanel">
<button type="button" class="collapsible">Attendance Table Data <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Saved attendance data. Data can be edited but cannot be deleted.</p>
</div>

<div class="table-container">
<table id="absenTabelTable">
<thead>
<tr>
<th>Work Area</th>
<th>Employee Name</th>
<th>Job Position</th>
<!-- Date columns will be filled by JavaScript -->
<th>Action</th>
</tr>
</thead>
<tbody>
<!-- Data will be filled by JavaScript -->
</tbody>
</table>
</div>
</div>

<!-- Cuti Tab -->
<div class="tab-pane fade" id="cuti" role="tabpanel">
<button type="button" class="collapsible">Leave Management <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Here you can manage employee leave data.</p>
</div>

<div class="cuti-form">
<h5>Add Employee Leave</h5>
<div class="row g-2">
<div class="col-12 col-md-6 col-lg-4">
<label for="cutiEmployee" class="form-label">Employee Name</label>
<select class="form-select form-select-sm" id="cutiEmployee">
<!-- Options will be filled by JavaScript -->
</select>
</div>
<div class="col-12 col-md-6 col-lg-3">
<label for="cutiStartDate" class="form-label">Start Date</label>
<input type="date" class="form-control form-control-sm" id="cutiStartDate">
</div>
<div class="col-12 col-md-6 col-lg-3">
<label for="cutiEndDate" class="form-label">End Date</label>
<input type="date" class="form-control form-control-sm" id="cutiEndDate">
</div>
<div class="col-12 col-md-6 col-lg-2 d-flex align-items-end">
<button class="btn btn-futuristic btn-sm w-100" id="addCuti">
<i class="fas fa-plus me-1"></i> Add
</button>
</div>
</div>
</div>

<div class="table-responsive">
<table class="table table-striped table-sm" id="cutiTable">
<thead>
<tr>
<th>No</th>
<th>Employee Name</th>
<th>Start Date</th>
<th>End Date</th>
<th>Duration (Days)</th>
<th>Remarks</th>
<th>Action</th>
</tr>
</thead>
<tbody id="cutiTableBody">
<!-- Data will be filled by JavaScript -->
</tbody>
</table>
</div>

<div class="action-buttons">
<button class="btn btn-futuristic" id="saveCuti">
<i class="fas fa-save me-1"></i> Save Leave Data
</button>
</div>
</div>

<!-- Cuti Detail Tab -->
<div class="tab-pane fade" id="cuti-detail" role="tabpanel">
<button type="button" class="collapsible">Employee Leave Details <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Detailed employee leave data that has been saved.</p>
</div>

<div class="table-responsive">
<table class="cuti-detail-table table-striped table-sm" id="cutiDetailTable">
<thead>
<tr>
<th>No</th>
<th>Employee Name</th>
<th>Work Area</th>
<th>Job Position</th>
<th>Start Date</th>
<th>End Date</th>
<th>Duration (Days)</th>
<th>Remaining Leave</th>
<th>Action</th>
</tr>
</thead>
<tbody id="cutiDetailTableBody">
<!-- Data will be filled by JavaScript -->
</tbody>
</table>
</div>
</div>

<!-- Form Rekap Lembur Tab - MODIFIED -->
<div class="tab-pane fade" id="form-rekap-lembur" role="tabpanel">
<button type="button" class="collapsible">Overtime Form <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Fill in the overtime form to record your overtime activities. You can only view your own overtime data.</p>
</div>

<div class="overtime-form-container">
<h5>Overtime Form</h5>
<div class="overtime-form-row">
<div class="overtime-form-group">
<label for="rekapDate">Date</label>
<input type="date" class="form-control form-control-sm" id="rekapDate">
</div>
<div class="overtime-form-group">
<label for="rekapStartTime">Start Time</label>
<input type="time" class="form-control form-control-sm" id="rekapStartTime">
</div>
<div class="overtime-form-group">
<label for="rekapEndTime">End Time</label>
<input type="time" class="form-control form-control-sm" id="rekapEndTime">
</div>
</div>

<div class="table-responsive">
<table class="overtime-table table-striped table-sm" id="rekapLemburTable">
<thead>
<tr>
<th>No</th>
<th>Total Project</th>
<th>Total Plant</th>
<th>Plant Name</th>
<th>Volume (m3)</th>
<th>Action</th>
</tr>
</thead>
<tbody id="rekapLemburTableBody">
<!-- Data akan diisi oleh JavaScript -->
</tbody>
</table>
</div>

<!-- PERBAIKAN: Tombol Add Row dihilangkan -->

<div class="form-group mt-3">
<label for="uraianTugas">Task Description</label>
<textarea class="form-control form-control-sm" id="uraianTugas" rows="3" placeholder="Describe your overtime tasks..."></textarea>
</div>

<div class="action-buttons mt-3">
<button class="btn btn-futuristic" id="saveRekapLembur">
<i class="fas fa-save me-1"></i> Save
</button>
</div>
</div>

<!-- Overtime Detail Table -->
<div class="table-responsive mt-4" id="overtimeDetailContainer">
<h5>Overtime Detail</h5>
<table class="overtime-table table-striped table-sm" id="overtimeDetailTable">
<thead>
<tr>
<th>No</th>
<th>Date</th>
<th>Start Time</th>
<th>End Time</th>
<th>Total Project</th>
<th>Total Plant</th>
<th>Plant Name</th>
<th>Volume (m3)</th>
<th>Task Description</th>
<th>Action</th>
</tr>
</thead>
<tbody id="overtimeDetailTableBody">
<!-- Data akan diisi setelah menyimpan -->
</tbody>
</table>
</div>

<!-- Total Overtime Display -->
<div class="total-overtime-display">
<span>Total Overtime: </span>
<span class="total-overtime-value" id="totalOvertimeValue">00:00</span>
</div>
</div>

<!-- Setting Tab -->
<div class="tab-pane fade" id="setting" role="tabpanel">
<button type="button" class="collapsible">System Settings <i class="fas fa-chevron-down"></i></button>
<div class="collapsible-content">
<p class="small">Here you can manage users and system settings.</p>
</div>

<div class="row">
<div class="col-12">
<h5>Change Password</h5>
<div class="row g-2">
<div class="col-12 col-md-4">
<div class="mb-3">
<label for="currentPassword" class="form-label">Current Password</label>
<input type="password" class="form-control form-control-sm" id="currentPassword">
</div>
</div>
<div class="col-12 col-md-4">
<div class="mb-3">
<label for="newPassword" class="form-label">New Password</label>
<input type="password" class="form-control form-control-sm" id="newPassword">
</div>
</div>
<div class="col-12 col-md-4">
<div class="mb-3">
<label for="confirmPassword" class="form-label">Confirm New Password</label>
<input type="password" class="form-control form-control-sm" id="confirmPassword">
</div>
</div>
</div>
<button class="btn btn-futuristic" id="changePasswordBtn">
<i class="fas fa-key me-1"></i> Change Password
</button>
</div>
</div>

<hr>

<div class="row">
<div class="col-12">
<h5>User Management</h5>
<div class="mb-3">
<button class="btn btn-futuristic" data-bs-toggle="modal" data-bs-target="#addUserModal">
<i class="fas fa-user-plus me-1"></i> Add User
</button>
</div>
<div class="table-responsive">
<table class="user-table table-striped table-sm">
<thead>
<tr>
<th>Email</th>
<th>Role</th>
<th>Action</th>
</tr>
</thead>
<tbody id="userTableBody">
<!-- Data will be filled by JavaScript -->
</tbody>
</table>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<!-- Modal untuk Tambah Pengguna -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div class="mb-3">
<label for="newUserEmail" class="form-label">Email</label>
<input type="email" class="form-control form-control-sm" id="newUserEmail">
</div>
<div class="mb-3">
<label for="newUserPassword" class="form-label">Password</label>
<input type="password" class="form-control form-control-sm" id="newUserPassword">
</div>
<div class="mb-3">
<label for="newUserRole" class="form-label">Role</label>
<select class="form-select form-select-sm" id="newUserRole">
<option value="user">User</option>
<option value="admin">Admin</option>
</select>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
<button type="button" class="btn btn-futuristic btn-sm" id="saveUserBtn">Save</button>
</div>
</div>
</div>
</div>

<!-- Modal untuk Edit Pengguna -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<input type="hidden" id="editUserId">
<div class="mb-3">
<label for="editUserEmail" class="form-label">Email</label>
<input type="email" class="form-control form-control-sm" id="editUserEmail" readonly>
</div>
<div class="mb-3">
<label for="editUserRole" class="form-label">Role</label>
<select class="form-select form-select-sm" id="editUserRole">
<option value="user">User</option>
<option value="admin">Admin</option>
</select>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
<button type="button" class="btn btn-futuristic btn-sm" id="updateUserBtn">Update</button>
</div>
</div>
</div>
</div>

<!-- Modal untuk Ganti Password (User) -->
<div class="modal fade" id="changePasswordModal" tabindex="-1" aria-labelledby="changePasswordModalLabel" aria-hidden="true">
<div class="modal-dialog modal-dialog-centered">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="changePasswordModalLabel">Change Password</h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div class="mb-3">
<label for="userCurrentPassword" class="form-label">Current Password</label>
<input type="password" class="form-control form-control-sm" id="userCurrentPassword">
</div>
<div class="mb-3">
<label for="userNewPassword" class="form-label">New Password</label>
<input type="password" class="form-control form-control-sm" id="userNewPassword">
</div>
<div class="mb-3">
<label for="userConfirmPassword" class="form-label">Confirm New Password</label>
<input type="password" class="form-control form-control-sm" id="userConfirmPassword">
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Cancel</button>
<button type="button" class="btn btn-futuristic btn-sm" id="userChangePasswordBtn">Change Password</button>
</div>
</div>
</div>
</div>

<!-- Modal untuk View Leave Details -->
<div class="modal fade leave-detail-modal" id="viewLeaveDetailModal" tabindex="-1" aria-labelledby="viewLeaveDetailModalLabel" aria-hidden="true">
<div class="modal-dialog modal-lg">
<div class="modal-content">
<div class="modal-header">
<h5 class="modal-title" id="viewLeaveDetailModalLabel">Leave Details - <span id="modalEmployeeName"></span></h5>
<button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
</div>
<div class="modal-body">
<div class="table-responsive">
<table class="table table-striped table-sm">
<thead>
<tr>
<th>Start Date</th>
<th>End Date</th>
<th>Duration (Days)</th>
<th>Remarks</th>
</tr>
</thead>
<tbody id="leaveDetailTableBody">
<!-- Data akan diisi oleh JavaScript -->
</tbody>
</table>
</div>
</div>
<div class="modal-footer">
<button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
</div>
</div>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
// Initialize Firebase dengan konfigurasi yang benar
const firebaseConfig = {
apiKey: "AIzaSyCs_65P_SLx529UwLcQO8cF69yD1yLOgKY",
authDomain: "blueiiifirebase.firebaseapp.com",
projectId: "blueiiifirebase",
storageBucket: "blueiiifirebase.firebasestorage.app",
messagingSenderId: "194236727932",
appId: "1:194236727932:web:6b10d6302d5c56ebac3ff9"
};

// Cek jika Firebase sudah diinisialisasi
if (!firebase.apps.length) {
firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore();

// Enable offline persistence
db.enablePersistence()
.catch((err) => {
console.log('Persistence failed: ', err);
});

// Data matrik untuk shift
const shiftMatrix = {
"Dispatcher": {
"1": { name: "Morning", checkIn: "07:00", checkOut: "15:00", hours: "07:00" },
"2": { name: "Afternoon", checkIn: "15:00", checkOut: "23:00", hours: "07:00" },
"3": { name: "Night", checkIn: "23:00", checkOut: "07:00", hours: "08:00" },
"11": { name: "Morning Part", checkIn: "07:00", checkOut: "12:00", hours: "05:00" },
"22": { name: "Afternoon Part", checkIn: "15:00", checkOut: "20:00", hours: "05:00" },
"C": { name: "Leave", checkIn: "", checkOut: "", hours: "" },
"O": { name: "Off", checkIn: "", checkOut: "", hours: "" }
},
"Booking": {
"1": { name: "Morning", checkIn: "08:00", checkOut: "16:00", hours: "07:00" },
"2": { name: "Afternoon", checkIn: "16:00", checkOut: "24:00", hours: "08:00" },
"3": { name: "Night", checkIn: "00:00", checkOut: "08:00", hours: "08:00" },
"11": { name: "Morning Part", checkIn: "08:00", checkOut: "13:00", hours: "05:00" },
"22": { name: "Afternoon Part", checkIn: "16:00", checkOut: "21:00", hours: "05:00" },
"C": { name: "Leave", checkIn: "", checkOut: "", hours: "" },
"O": { name: "Off", checkIn: "", checkOut: "", hours: "" }
}
};

// Data awal karyawan dengan urutan default
const initialEmployees = [
{ area: "CDC East", name: "Fahmi Ardiansah", position: "Dispatcher" },
{ area: "CDC East", name: "Agung Setyawan", position: "Dispatcher" },
{ area: "CDC East", name: "Drajat Triono", position: "Dispatcher" },
{ area: "CDC East", name: "Wiyanto", position: "Dispatcher" },
{ area: "CDC East", name: "Nur Fauziah", position: "Booking" }
];

// Variabel global
let absensiData = [];
let absenTabelData = [];
let outputData = []; // Data untuk output table
let overtimeCalcData = []; // Data untuk overtime calculation table
let dateRangeMain = []; // Date range untuk Main folder
let dateRangeGeneral = []; // Date range untuk General folder
let remarksData = {};
let overtimeData = {};
let currentTab = "entry";
let users = [];
let cutiData = [];
let cutiDetailData = [];
let currentUser = null;
let rekapLemburData = [];
let formRekapLemburData = [];
let isOnline = navigator.onLine;
let currentFocusedCell = null; // Untuk navigasi keyboard
let isSaving = false; // Flag to prevent multiple saves
let outputDataLoaded = false; // Flag to track if output data has been loaded
let overtimeDataLoaded = false; // Flag to track if overtime data has been loaded

// Variabel untuk Overtime Form
let currentRekapRows = [];
let plantOptions = ["Denpasar2", "Gianyar", "Manyar", "Manukan", "Gempol", "Kediri", "Krian"];

// Fungsi untuk mengecek koneksi
function checkConnection() {
const statusElement = document.getElementById('connectionStatus');
const loginOfflineMessage = document.getElementById('loginOfflineMessage');
const appOfflineMessage = document.getElementById('appOfflineMessage');

if (isOnline) {
statusElement.textContent = 'Online';
statusElement.className = 'connection-status connection-online';
loginOfflineMessage.style.display = 'none';
appOfflineMessage.style.display = 'none';
} else {
statusElement.textContent = 'Offline';
statusElement.className = 'connection-status connection-offline';
loginOfflineMessage.style.display = 'block';
if (currentUser) {
appOfflineMessage.style.display = 'block';
}
}
statusElement.style.display = 'block';
}

// Event listeners untuk koneksi
window.addEventListener('online', () => {
isOnline = true;
checkConnection();
console.log('Connection restored');
// Sync data ketika koneksi kembali
if (currentUser) {
saveDataToFirestore();
}
});

window.addEventListener('offline', () => {
isOnline = false;
checkConnection();
console.log('Connection lost');
});

// Fungsi untuk handle error Firebase
function handleFirebaseError(error, operation = 'operation') {
console.error(`Firebase error during ${operation}:`, error);

if (error.code === 'failed-precondition') {
alert('Multiple tabs open. Please close other tabs and refresh this page.');
} else if (error.code === 'unavailable') {
if (isOnline) {
alert('Service unavailable. Please check your connection.');
}
// Jika offline, tidak perlu menampilkan alert
} else {
alert(`Error: ${error.message}`);
}

return false;
}

// Fungsi untuk login dengan error handling
async function login(email, password) {
showLoading(true);

try {
// Clear previous errors
document.getElementById('loginError').style.display = 'none';

const userCredential = await auth.signInWithEmailAndPassword(email, password);
currentUser = {
uid: userCredential.user.uid,
email: userCredential.user.email
};

// Try to get user data from Firestore
let userData;
try {
const userDoc = await db.collection('users').doc(currentUser.uid).get();

if (userDoc.exists) {
userData = userDoc.data();
currentUser.role = userData.role;
currentUser.name = userData.name;
} else {
// Create default user data if doesn't exist
currentUser.role = "user";
currentUser.name = currentUser.email.split('@')[0];

await db.collection('users').doc(currentUser.uid).set({
email: currentUser.email,
role: currentUser.role,
name: currentUser.name,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
});
}
} catch (firestoreError) {
// If Firestore is unavailable, use default values
console.warn('Firestore unavailable, using default values:', firestoreError);
currentUser.role = "user";
currentUser.name = currentUser.email.split('@')[0];
}

// Update UI
document.getElementById('loginContainer').style.display = 'none';
document.getElementById('sidebar').style.display = 'block';
document.getElementById('userPasswordSection').style.display = 'block';
document.getElementById('mainContent').style.display = 'block';
document.querySelector('.futuristic-header').style.display = 'block';

document.querySelector('.header-subtitle').innerHTML = `Modern and Efficient Attendance Management | Logged in as: ${currentUser.name} (${currentUser.role})`;

setupMenuByRole(currentUser.role);
setupFilterByRole(currentUser.role);

// Load initial data
await loadInitialData();

showLoading(false);
checkConnection();

} catch (error) {
console.error('Login error:', error);
document.getElementById('loginError').textContent = error.message;
document.getElementById('loginError').style.display = 'block';
showLoading(false);
}
}

// Fungsi untuk load data initial dengan error handling
async function loadInitialData() {
showLoading(true);

try {
// Set default dates untuk Main folder
const today = new Date();
const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
document.getElementById('startDateMain').valueAsDate = firstDayOfMonth;
document.getElementById('endDateMain').valueAsDate = today;

// Set default dates untuk General folder
document.getElementById('startDateGeneral').valueAsDate = firstDayOfMonth;
document.getElementById('endDateGeneral').valueAsDate = today;

// Try to load data from Firestore
try {
const [absensiSnapshot, settingsSnapshot, absenTabelSnapshot, cutiSnapshot] = await Promise.all([
db.collection('absensi').limit(50).get(),
db.collection('settings').doc('dateRange').get().catch(() => null),
db.collection('absenTabel').limit(50).get().catch(() => null),
db.collection('cuti').limit(50).get().catch(() => null)
]);

absensiData = [];
absensiSnapshot.forEach(doc => {
absensiData.push({
id: doc.id,
...doc.data()
});
});

// Load absen tabel data
absenTabelData = [];
if (absenTabelSnapshot) {
absenTabelSnapshot.forEach(doc => {
absenTabelData.push({
id: doc.id,
...doc.data()
});
});
}

// Load cuti data
cutiData = [];
if (cutiSnapshot) {
cutiSnapshot.forEach(doc => {
cutiData.push({
id: doc.id,
...doc.data()
});
});
}

// Apply date settings if available
if (settingsSnapshot && settingsSnapshot.exists) {
const settings = settingsSnapshot.data();
if (settings.startDate) document.getElementById('startDateMain').value = settings.startDate;
if (settings.endDate) document.getElementById('endDateMain').value = settings.endDate;
}

} catch (firestoreError) {
console.warn('Could not load data from Firestore:', firestoreError);
// Use initial employees if Firestore is unavailable
absensiData = [...initialEmployees];
}

// Setup UI components
initCollapsible();
applyDateFilterMain(); // Apply filter untuk Main folder
updateEmployeeDropdown();
updateCutiEmployeeDropdown();
initSidebar();
initMobileMenu();

// Set active tab based on role
if (currentUser.role === 'user') {
document.querySelector('[data-tab="absen-tabel"]').click();
} else {
document.querySelector('[data-tab="entry"]').click();
}

} catch (error) {
console.error('Error loading initial data:', error);
} finally {
showLoading(false);
}
}

// Fungsi untuk menyimpan data dengan offline support
async function saveDataToFirestore() {
if (isSaving) return; // Prevent multiple saves
isSaving = true;

if (!isOnline) {
console.log('Offline - data will be saved when connection is restored');
// Simpan ke localStorage sebagai backup
localStorage.setItem('absensiDataBackup', JSON.stringify(absensiData));
isSaving = false;
return;
}

try {
// Collect data from table
absensiData = [];
const rows = document.querySelectorAll('#entryTable tbody tr');

rows.forEach(row => {
const areaInput = row.querySelector('.area-input');
const nameInput = row.querySelector('.name-input');
const positionInput = row.querySelector('.position-input');

if (!areaInput || !nameInput || !positionInput) return;

const area = areaInput.value;
const name = nameInput.value;
const position = positionInput.value;

if (!name) return; // Skip empty rows

const shifts = {};
const shiftInputs = row.querySelectorAll('.shift-input');

shiftInputs.forEach((input, index) => {
if (index < dateRangeMain.length) {
const date = dateRangeMain[index];
const dateKey = formatDateForShift(date);
shifts[dateKey] = input.value.toUpperCase();
}
});

absensiData.push({ area, name, position, shifts });
});

// Save to Firestore in batch
const batch = db.batch();

// Clear existing data
const absensiSnapshot = await db.collection('absensi').get();
absensiSnapshot.forEach(doc => {
batch.delete(doc.ref);
});

// Add new data
absensiData.forEach(data => {
const docRef = db.collection('absensi').doc();
batch.set(docRef, data);
});

// Save settings
const dateRangeRef = db.collection('settings').doc('dateRange');
batch.set(dateRangeRef, {
startDate: document.getElementById('startDateMain').value,
endDate: document.getElementById('endDateMain').value,
lastUpdated: firebase.firestore.FieldValue.serverTimestamp()
});

await batch.commit();
console.log('Data saved successfully');

// Generate output and overtime calculation data
generateOutputAndOvertimeData();

// PERBAIKAN: Tampilkan notifikasi sukses hanya saat tombol save diklik
showNotification('Data saved successfully!', 'success');

// Hapus backup setelah berhasil sync
localStorage.removeItem('absensiDataBackup');

} catch (error) {
console.error('Error saving data:', error);
showNotification('Error saving data: ' + error.message, 'error');
if (error.code !== 'failed-precondition') {
// Simpan ke localStorage sebagai backup
localStorage.setItem('absensiDataBackup', JSON.stringify(absensiData));
}
} finally {
isSaving = false;
}
}

// Fungsi untuk generate output dan overtime calculation data
function generateOutputAndOvertimeData() {
outputData = [];
overtimeCalcData = [];

absensiData.forEach(employee => {
const area = employee.area;
const name = employee.name;
const position = employee.position;

// Loop through the shifts
Object.keys(employee.shifts || {}).forEach(dateStr => {
const shiftCode = employee.shifts[dateStr];
if (shiftCode) { // if not empty
// Get shift details from shiftMatrix
const shiftDetails = shiftMatrix[position] && shiftMatrix[position][shiftCode];

if (shiftDetails) {
// For outputData
outputData.push({
area,
name,
position,
date: dateStr,
shift: shiftDetails.name, // use the name (without code)
shiftCheckIn: shiftDetails.checkIn,
shiftCheckOut: shiftDetails.checkOut,
remarks: "" // initially empty
});

// For overtimeCalcData
overtimeCalcData.push({
area,
name,
position,
date: dateStr,
shift: shiftCode, // we keep the code for overtime
shiftCheckIn: shiftDetails.checkIn,
shiftCheckOut: shiftDetails.checkOut,
wtNormal: shiftDetails.hours,
actualCheckIn: "",
actualCheckOut: "",
overTime: "",
cekRMC: "",
rkpPIC: "",
rmcShiftCheckOut: "",
remarks: ""
});
}
}
});
});

// Update the tables if the tabs are active
if (currentTab === "output") {
updateOutputTable();
}
if (currentTab === "overtime") {
updateOvertimeTable();
}
}

// Fungsi untuk update output table dengan filter
function updateOutputTable() {
const tbody = document.querySelector('#outputTable tbody');
tbody.innerHTML = '';

// Filter data berdasarkan date range General folder
const startDateGeneral = document.getElementById('startDateGeneral').valueAsDate;
const endDateGeneral = document.getElementById('endDateGeneral').valueAsDate;
const employeeFilterGeneral = document.getElementById('employeeNameGeneral').value;

let filteredOutputData = outputData.filter(data => {
const dataDate = parseDateFromString(data.date);
const dateInRange = (!startDateGeneral || !endDateGeneral) ||
(dataDate >= startDateGeneral && dataDate <= endDateGeneral);
const employeeMatch = employeeFilterGeneral === 'all' || data.name === employeeFilterGeneral;

return dateInRange && employeeMatch;
});

filteredOutputData.forEach(data => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${data.area}</td>
<td>${data.name}</td>
<td>${data.position}</td>
<td>${data.date}</td>
<td>${data.shift}</td>
<td>${data.shiftCheckIn}</td>
<td>${data.shiftCheckOut}</td>
<td><input type="text" class="remarks-input" value="${data.remarks}" data-employee="${data.name}" data-date="${data.date}"></td>
`;
tbody.appendChild(row);
});

// Add event listener for remarks input
document.querySelectorAll('.remarks-input').forEach(input => {
input.addEventListener('change', function() {
const employee = this.getAttribute('data-employee');
const date = this.getAttribute('data-date');
const remarks = this.value;

// Find the item in outputData and update remarks
const item = outputData.find(d => d.name === employee && d.date === date);
if (item) {
item.remarks = remarks;
}
});
});
}

// Fungsi untuk update overtime calculation table dengan filter
function updateOvertimeTable() {
const tbody = document.querySelector('#overtimeTableBody');
tbody.innerHTML = '';

// Filter data berdasarkan date range General folder
const startDateGeneral = document.getElementById('startDateGeneral').valueAsDate;
const endDateGeneral = document.getElementById('endDateGeneral').valueAsDate;
const employeeFilterGeneral = document.getElementById('employeeNameGeneral').value;

let filteredOvertimeData = overtimeCalcData.filter(data => {
const dataDate = parseDateFromString(data.date);
const dateInRange = (!startDateGeneral || !endDateGeneral) ||
(dataDate >= startDateGeneral && dataDate <= endDateGeneral);
const employeeMatch = employeeFilterGeneral === 'all' || data.name === employeeFilterGeneral;

return dateInRange && employeeMatch;
});

let no = 1;
filteredOvertimeData.forEach(data => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${no++}</td>
<td>${data.area}</td>
<td>${data.name}</td>
<td>${data.position}</td>
<td>${data.date}</td>
<td>${data.shift}</td>
<td>${data.shiftCheckIn}</td>
<td>${data.shiftCheckOut}</td>
<td>${data.wtNormal}</td>
<td><input type="time" class="actual-check-in" value="${data.actualCheckIn}" data-id="${data.id}"></td>
<td><input type="time" class="actual-check-out" value="${data.actualCheckOut}" data-id="${data.id}"></td>
<td><input type="text" class="over-time" value="${data.overTime}" data-id="${data.id}" readonly></td>
<td><input type="text" class="cek-rmc" value="${data.cekRMC}" data-id="${data.id}"></td>
<td><input type="text" class="rkp-pic" value="${data.rkpPIC}" data-id="${data.id}"></td>
<td><input type="text" class="rmc-shift-check-out" value="${data.rmcShiftCheckOut}" data-id="${data.id}" readonly></td>
<td><input type="text" class="remarks-input" value="${data.remarks}" data-id="${data.id}"></td>
`;
tbody.appendChild(row);
});

// Add event listeners untuk perhitungan otomatis
document.querySelectorAll('.actual-check-in, .actual-check-out, .cek-rmc').forEach(input => {
input.addEventListener('change', function() {
calculateOvertime(this);
});
});
}

// Fungsi untuk menghitung overtime secara otomatis
function calculateOvertime(input) {
const row = input.closest('tr');
const shiftCheckOut = row.querySelector('td:nth-child(8)').textContent;
const actualCheckIn = row.querySelector('.actual-check-in').value;
const actualCheckOut = row.querySelector('.actual-check-out').value;
const cekRMC = row.querySelector('.cek-rmc').value;

// Hitung overtime
if (actualCheckIn && actualCheckOut) {
const actualIn = new Date(`2000-01-01T${actualCheckIn}`);
const actualOut = new Date(`2000-01-01T${actualCheckOut}`);

// Jika check out di hari berikutnya (setelah tengah malam)
if (actualOut < actualIn) {
actualOut.setDate(actualOut.getDate() + 1);
}

const diffMs = actualOut - actualIn;
const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

const overtime = `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
row.querySelector('.over-time').value = overtime;

// Update data
const dataId = input.getAttribute('data-id');
if (dataId) {
const item = overtimeCalcData.find(d => d.id === dataId);
if (item) {
item.overTime = overtime;
}
}
}

// Hitung Rmc - Shift Check Out
if (cekRMC && shiftCheckOut) {
const rmcTime = new Date(`2000-01-01T${cekRMC}`);
const shiftOutTime = new Date(`2000-01-01T${shiftCheckOut}`);

// Jika RMC di hari berikutnya (setelah tengah malam)
if (rmcTime < shiftOutTime) {
rmcTime.setDate(rmcTime.getDate() + 1);
}

const diffMs = rmcTime - shiftOutTime;
const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

const rmcDiff = `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
row.querySelector('.rmc-shift-check-out').value = rmcDiff;

// Update data
const dataId = input.getAttribute('data-id');
if (dataId) {
const item = overtimeCalcData.find(d => d.id === dataId);
if (item) {
item.rmcShiftCheckOut = rmcDiff;
}
}
}
}

// PERBAIKAN: Fungsi untuk menyimpan data output ke Firestore
async function saveOutputDataToFirestore() {
if (!isOnline) {
console.log('Offline - data will be saved when connection is restored');
return;
}

try {
// Save to Firestore in batch
const batch = db.batch();

// Clear existing data in output collection
const outputSnapshot = await db.collection('output').get();
outputSnapshot.forEach(doc => {
batch.delete(doc.ref);
});

// Add new data to output collection
outputData.forEach(data => {
const docRef = db.collection('output').doc();
batch.set(docRef, data);
});

await batch.commit();
console.log('Output data saved successfully');

// PERBAIKAN: Tampilkan notifikasi sukses hanya saat tombol save diklik
showNotification('Output data saved successfully!', 'success');

} catch (error) {
console.error('Error saving output data:', error);
showNotification('Error saving output data: ' + error.message, 'error');
}
}

// PERBAIKAN: Fungsi untuk menyimpan data overtime ke Firestore
async function saveOvertimeDataToFirestore() {
if (!isOnline) {
console.log('Offline - data will be saved when connection is restored');
return;
}

try {
// Update data dari input fields
document.querySelectorAll('#overtimeTableBody tr').forEach(row => {
const dataId = row.querySelector('.actual-check-in').getAttribute('data-id');
if (dataId) {
const item = overtimeCalcData.find(d => d.id === dataId);
if (item) {
item.actualCheckIn = row.querySelector('.actual-check-in').value;
item.actualCheckOut = row.querySelector('.actual-check-out').value;
item.overTime = row.querySelector('.over-time').value;
item.cekRMC = row.querySelector('.cek-rmc').value;
item.rkpPIC = row.querySelector('.rkp-pic').value;
item.rmcShiftCheckOut = row.querySelector('.rmc-shift-check-out').value;
item.remarks = row.querySelector('.remarks-input').value;
}
}
});

// Save to Firestore in batch
const batch = db.batch();

// Clear existing data in overtime collection
const overtimeSnapshot = await db.collection('overtime').get();
overtimeSnapshot.forEach(doc => {
batch.delete(doc.ref);
});

// Add new data to overtime collection
overtimeCalcData.forEach(data => {
const docRef = db.collection('overtime').doc();
batch.set(docRef, data);
});

await batch.commit();
console.log('Overtime data saved successfully');

// PERBAIKAN: Tampilkan notifikasi sukses hanya saat tombol save diklik
showNotification('Overtime data saved successfully!', 'success');

} catch (error) {
console.error('Error saving overtime data:', error);
showNotification('Error saving overtime data: ' + error.message, 'error');
}
}

// PERBAIKAN: Fungsi untuk menyimpan data ke absen tabel (read-only)
async function saveDataToAbsenTabel() {
if (!isOnline) {
console.log('Offline - data will be saved when connection is restored');
return;
}

try {
// Collect data from table
const dataToSave = [];
const rows = document.querySelectorAll('#entryTable tbody tr');

rows.forEach(row => {
const areaInput = row.querySelector('.area-input');
const nameInput = row.querySelector('.name-input');
const positionInput = row.querySelector('.position-input');

if (!areaInput || !nameInput || !positionInput) return;

const area = areaInput.value;
const name = nameInput.value;
const position = positionInput.value;

if (!name) return; // Skip empty rows

const shifts = {};
const shiftInputs = row.querySelectorAll('.shift-input');

shiftInputs.forEach((input, index) => {
if (index < dateRangeMain.length) {
const date = dateRangeMain[index];
const dateKey = formatDateForShift(date);
shifts[dateKey] = input.value.toUpperCase();
}
});

dataToSave.push({ area, name, position, shifts });
});

// Save to Firestore in batch
const batch = db.batch();

// Clear existing data in absenTabel
const absenTabelSnapshot = await db.collection('absenTabel').get();
absenTabelSnapshot.forEach(doc => {
batch.delete(doc.ref);
});

// Add new data to absenTabel
dataToSave.forEach(data => {
const docRef = db.collection('absenTabel').doc();
batch.set(docRef, data);
});

await batch.commit();
console.log('Data saved to absen tabel successfully');

// PERBAIKAN: Tampilkan notifikasi sukses hanya saat tombol save diklik
showNotification('Data saved to Attendance Table successfully!', 'success');

// Refresh absen tabel data
await loadAbsenTabelData();

// Switch to absen tabel tab
document.querySelector('[data-tab="absen-tabel"]').click();

} catch (error) {
console.error('Error saving data to absen tabel:', error);
showNotification('Error saving data to Attendance Table: ' + error.message, 'error');
}
}

// PERBAIKAN: Fungsi untuk memuat data absen tabel
async function loadAbsenTabelData() {
try {
const absenTabelSnapshot = await db.collection('absenTabel').get();

absenTabelData = [];
absenTabelSnapshot.forEach(doc => {
absenTabelData.push({
id: doc.id,
...doc.data()
});
});

// Update absen tabel table
updateAbsenTabelTable();

} catch (error) {
console.error('Error loading absen tabel data:', error);
}
}

// PERBAIKAN: Fungsi untuk update tabel absen tabel
function updateAbsenTabelTable() {
const thead = document.querySelector('#absenTabelTable thead tr');
const tbody = document.querySelector('#absenTabelTable tbody');

// Update header - make it exactly the same as entry table
let headerHTML = '<th>Work Area</th><th>Employee Name</th><th>Job Position</th>';
dateRangeGeneral.forEach(date => {
headerHTML += `<th>${formatDateForHeader(date)}</th>`;
});
headerHTML += '<th>Action</th>';
thead.innerHTML = headerHTML;

// Update body
let tbodyHTML = '';

// Sort employees by default order
const sortedData = sortEmployeesByDefaultOrder(absenTabelData);

sortedData.forEach(employee => {
let rowHTML = `
<td><input type="text" value="${employee.area || ''}" class="area-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
<td><input type="text" value="${employee.name || ''}" class="name-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
<td><input type="text" value="${employee.position || ''}" class="position-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
`;

dateRangeGeneral.forEach(date => {
const dateStr = formatDateForShift(date);
const shiftValue = employee.shifts && employee.shifts[dateStr] ? employee.shifts[dateStr] : '';
rowHTML += `<td><input type="text" value="${shiftValue}" class="shift-input read-only-input" readonly></td>`;
});

// PERBAIKAN: Hapus tombol delete di absen tabel
rowHTML += '<td><button class="btn-edit" onclick="viewRow(this)"><i class="fas fa-eye"></i></button></td>';
tbodyHTML += `<tr>${rowHTML}</tr>`;
});

tbody.innerHTML = tbodyHTML;

// Apply shift colors
const shiftInputs = document.querySelectorAll('#absenTabelTable .shift-input');
shiftInputs.forEach(input => {
updateShiftColor(input);
});
}

// PERBAIKAN: Fungsi untuk melihat detail row (tanpa mengedit)
function viewRow(button) {
const row = button.closest('tr');
const name = row.querySelector('.name-input').value;
const position = row.querySelector('.position-input').value;

showNotification(`Viewing details for ${name} - ${position}`, 'info');
}

// Fungsi untuk mengurutkan karyawan sesuai urutan default
function sortEmployeesByDefaultOrder(employees) {
const nameOrder = ["Fahmi Ardiansah", "Agung Setyawan", "Drajat Triono", "Wiyanto", "Nur Fauziah"];
const sorted = [...employees];
sorted.sort((a, b) => {
const orderA = nameOrder.indexOf(a.name);
const orderB = nameOrder.indexOf(b.name);
return (orderA === -1 ? 999 : orderA) - (orderB === -1 ? 999 : orderB);
});
return sorted;
}

// Fungsi format tanggal
function formatDate(date) {
return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
}

function formatDateForShift(date) {
return `${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}/${date.getFullYear()}`;
}

function formatDateForHeader(date) {
const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
const dayName = dayNames[date.getDay()];
return `${dayName} ${String(date.getDate()).padStart(2, '0')}/${String(date.getMonth() + 1).padStart(2, '0')}`;
}

// Fungsi untuk parse tanggal dari string
function parseDateFromString(dateStr) {
const parts = dateStr.split('/');
if (parts.length === 3) {
return new Date(parts[2], parts[1] - 1, parts[0]);
}
return null;
}

// Fungsi untuk mengupdate warna sel
function updateShiftColor(input) {
const value = input.value.toUpperCase();
const td = input.parentElement;

// Remove all shift classes
td.className = td.className.replace(/\bshift-\S+/g, '');

// Add appropriate class
if (value === "1") td.classList.add("shift-1");
else if (value === "2") td.classList.add("shift-2");
else if (value === "3") td.classList.add("shift-3");
else if (value === "11") td.classList.add("shift-11");
else if (value === "22") td.classList.add("shift-22");
else if (value === "C") td.classList.add("shift-C");
else if (value === "O") td.classList.add("shift-O");

// PERBAIKAN: Hapus auto-save saat update warna shift
// Auto-save hanya dilakukan saat tombol save diklik
}

// Setup menu berdasarkan role
function setupMenuByRole(role) {
// Sembunyikan semua menu dulu
document.querySelectorAll('.sidebar-menu a').forEach(menu => {
menu.style.display = 'none';
});

document.querySelectorAll('.sidebar-folder').forEach(folder => {
folder.style.display = 'none';
});

// Tampilkan menu General untuk semua role
document.getElementById('generalFolder').style.display = 'block';
document.querySelectorAll('#generalFolder .sidebar-menu a').forEach(menu => {
menu.style.display = 'flex';
});

// Tampilkan menu Main dan Settings untuk admin
if (role === 'admin') {
document.getElementById('mainFolder').style.display = 'block';
document.querySelectorAll('#mainFolder .sidebar-menu a').forEach(menu => {
menu.style.display = 'flex';
});
document.querySelector('[data-tab="setting"]').style.display = 'flex';
}

// Tampilkan logout untuk semua role
document.getElementById('logoutBtn').style.display = 'flex';
}

// Setup filter berdasarkan role
function setupFilterByRole(role) {
const employeeFilterContainerMain = document.getElementById('employeeFilterContainerMain');
const employeeFilterContainerGeneral = document.getElementById('employeeFilterContainerGeneral');

// PERBAIKAN: Sembunyikan filter employee untuk semua role
employeeFilterContainerMain.style.display = 'none';
employeeFilterContainerGeneral.style.display = 'none';
}

// Fungsi untuk apply filter tanggal Main folder
function applyDateFilterMain() {
const startDate = document.getElementById('startDateMain').valueAsDate;
const endDate = document.getElementById('endDateMain').valueAsDate;

if (!startDate || !endDate) return;

dateRangeMain = [];
let currentDate = new Date(startDate);

while (currentDate <= endDate) {
dateRangeMain.push(new Date(currentDate));
currentDate.setDate(currentDate.getDate() + 1);
}

// Batasi maksimal 31 hari untuk performa
if (dateRangeMain.length > 31) {
alert('Date range limited to 31 days for better performance');
dateRangeMain = dateRangeMain.slice(0, 31);
document.getElementById('endDateMain').valueAsDate = dateRangeMain[dateRangeMain.length - 1];
}

updateEntryTable();
}

// Fungsi untuk apply filter tanggal General folder
function applyDateFilterGeneral() {
const startDate = document.getElementById('startDateGeneral').valueAsDate;
const endDate = document.getElementById('endDateGeneral').valueAsDate;

if (!startDate || !endDate) return;

dateRangeGeneral = [];
let currentDate = new Date(startDate);

while (currentDate <= endDate) {
dateRangeGeneral.push(new Date(currentDate));
currentDate.setDate(currentDate.getDate() + 1);
}

// Batasi maksimal 31 hari untuk performa
if (dateRangeGeneral.length > 31) {
alert('Date range limited to 31 days for better performance');
dateRangeGeneral = dateRangeGeneral.slice(0, 31);
document.getElementById('endDateGeneral').valueAsDate = dateRangeGeneral[dateRangeGeneral.length - 1];
}

// Update tables yang menggunakan filter General
if (currentTab === "absen-tabel") {
updateAbsenTabelTable();
}
if (currentTab === "output") {
updateOutputTable();
}
if (currentTab === "overtime") {
updateOvertimeTable();
}
if (currentTab === "cuti-detail") {
generateCutiDetailData();
}
}

// Update entry table
function updateEntryTable() {
const thead = document.querySelector('#entryTable thead tr');
const tbody = document.querySelector('#entryTable tbody');

// Update header
let headerHTML = '<th>Work Area</th><th>Employee Name</th><th>Job Position</th>';
dateRangeMain.forEach(date => {
headerHTML += `<th>${formatDateForHeader(date)}</th>`;
});
headerHTML += '<th>Action</th>';
thead.innerHTML = headerHTML;

// Update body
updateEntryTableBody();
initializeShiftColors();

// Terapkan pengaturan header yang tersimpan
loadHeaderSettings();

// PERBAIKAN: Setup navigasi keyboard
setupKeyboardNavigation();
}

function updateEntryTableBody() {
const tbody = document.querySelector('#entryTable tbody');
const employeesToShow = absensiData.length > 0 ? absensiData : initialEmployees;

// Sort employees by default order
const sortedEmployees = sortEmployeesByDefaultOrder(employeesToShow);

let tbodyHTML = '';

sortedEmployees.forEach(employee => {
let rowHTML = `
<td><input type="text" value="${employee.area || ''}" class="area-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
<td><input type="text" value="${employee.name || ''}" class="name-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
<td><input type="text" value="${employee.position || ''}" class="position-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
`;

dateRangeMain.forEach(date => {
const dateStr = formatDateForShift(date);
const shiftValue = employee.shifts && employee.shifts[dateStr] ? employee.shifts[dateStr] : '';
rowHTML += `<td><input type="text" value="${shiftValue}" class="shift-input editable-cell" onchange="updateShiftColor(this)"></td>`;
});

rowHTML += '<td><button class="btn-delete" onclick="deleteRow(this)"><i class="fas fa-trash"></i></button></td>';
tbodyHTML += `<tr>${rowHTML}</tr>`;
});

tbody.innerHTML = tbodyHTML;
}

// PERBAIKAN: Setup navigasi keyboard
function setupKeyboardNavigation() {
const table = document.querySelector('#entryTable');
if (!table) return;

// Add event listener for keyboard navigation
table.addEventListener('keydown', function(e) {
if (!currentFocusedCell) return;

const cell = currentFocusedCell;
const row = cell.closest('tr');
const cells = Array.from(row.querySelectorAll('input.editable-cell'));
const cellIndex = cells.indexOf(cell);

let targetCell = null;

switch(e.key) {
case 'ArrowUp':
e.preventDefault();
const prevRow = row.previousElementSibling;
if (prevRow) {
const prevCells = prevRow.querySelectorAll('input.editable-cell');
if (prevCells[cellIndex]) {
targetCell = prevCells[cellIndex];
}
}
break;
case 'ArrowDown':
e.preventDefault();
const nextRow = row.nextElementSibling;
if (nextRow) {
const nextCells = nextRow.querySelectorAll('input.editable-cell');
if (nextCells[cellIndex]) {
targetCell = nextCells[cellIndex];
}
}
break;
case 'ArrowLeft':
e.preventDefault();
if (cellIndex > 0) {
targetCell = cells[cellIndex - 1];
}
break;
case 'ArrowRight':
e.preventDefault();
if (cellIndex < cells.length - 1) {
targetCell = cells[cellIndex + 1];
}
break;
case 'Tab':
// Allow default tab behavior
break;
}

if (targetCell) {
targetCell.focus();
targetCell.select();
currentFocusedCell = targetCell;
}
});

// Set focus on cell click
table.addEventListener('click', function(e) {
if (e.target.classList.contains('editable-cell')) {
currentFocusedCell = e.target;
}
});

// Set focus on cell focus
table.addEventListener('focusin', function(e) {
if (e.target.classList.contains('editable-cell')) {
currentFocusedCell = e.target;
}
});
}

// Fungsi untuk membuat input editable
function makeEditable(input) {
input.readOnly = false;
input.focus();
input.select();

input.addEventListener('blur', function() {
this.readOnly = true;
updateEmployeeDropdown();
updateCutiEmployeeDropdown();
}, { once: true });
}

// Fungsi untuk delete row
function deleteRow(button) {
if (currentTab === "absen-tabel") return;

const row = button.closest('tr');
const name = row.querySelector('.name-input').value;
const position = row.querySelector('.position-input').value;

absensiData = absensiData.filter(emp => !(emp.name === name && emp.position === position));
row.remove();

updateEmployeeDropdown();
updateCutiEmployeeDropdown();
}

// Update employee dropdown
function updateEmployeeDropdown() {
const employeeDropdownMain = document.getElementById('employeeNameMain');
const employeeDropdownGeneral = document.getElementById('employeeNameGeneral');

// Update Main folder dropdown
updateEmployeeDropdownForElement(employeeDropdownMain);

// Update General folder dropdown
updateEmployeeDropdownForElement(employeeDropdownGeneral);
}

function updateEmployeeDropdownForElement(dropdownElement) {
const currentValue = dropdownElement.value;

// Clear existing options except "Select All"
while (dropdownElement.options.length > 1) {
dropdownElement.remove(1);
}

const uniqueNames = new Set();
absensiData.forEach(employee => {
if (employee.name) uniqueNames.add(employee.name);
});

if (uniqueNames.size === 0) {
initialEmployees.forEach(employee => {
uniqueNames.add(employee.name);
});
}

uniqueNames.forEach(name => {
const option = document.createElement('option');
option.value = name;
option.textContent = name;
dropdownElement.appendChild(option);
});

if (currentValue !== 'all' && uniqueNames.has(currentValue)) {
dropdownElement.value = currentValue;
}
}

// Update cuti employee dropdown
function updateCutiEmployeeDropdown() {
const cutiEmployeeDropdown = document.getElementById('cutiEmployee');
const currentValue = cutiEmployeeDropdown.value;

// Clear existing options
cutiEmployeeDropdown.innerHTML = '';

const uniqueNames = new Set();
absensiData.forEach(employee => {
if (employee.name) uniqueNames.add(employee.name);
});

if (uniqueNames.size === 0) {
initialEmployees.forEach(employee => {
uniqueNames.add(employee.name);
});
}

uniqueNames.forEach(name => {
const option = document.createElement('option');
option.value = name;
option.textContent = name;
cutiEmployeeDropdown.appendChild(option);
});

if (currentValue && uniqueNames.has(currentValue)) {
cutiEmployeeDropdown.value = currentValue;
}
}

// Initialize shift colors
function initializeShiftColors() {
const shiftInputs = document.querySelectorAll('.shift-input');
shiftInputs.forEach(input => {
updateShiftColor(input);
});
}

// Fungsi untuk logout
function logout() {
auth.signOut().then(() => {
currentUser = null;
// Reset UI ke state login
document.getElementById('loginContainer').style.display = 'flex';
document.getElementById('sidebar').style.display = 'none';
document.getElementById('userPasswordSection').style.display = 'none';
document.getElementById('mainContent').style.display = 'none';
document.querySelector('.futuristic-header').style.display = 'none';

// Clear form fields
document.getElementById('email').value = '';
document.getElementById('password').value = '';
document.getElementById('loginError').style.display = 'none';
}).catch((error) => {
console.error('Logout error:', error);
});
}

// Initialize sidebar
function initSidebar() {
const sidebar = document.getElementById('sidebar');
const sidebarToggle = document.getElementById('sidebarToggle');

sidebarToggle.addEventListener('click', function() {
sidebar.classList.toggle('expanded');
document.getElementById('mainContent').classList.toggle('expanded');
document.body.classList.toggle('header-expanded');
document.getElementById('userPasswordSection').classList.toggle('expanded');
});

// Folder toggle
document.querySelectorAll('.sidebar-folder-header').forEach(header => {
header.addEventListener('click', function() {
this.parentElement.classList.toggle('expanded');
});
});

// Menu item clicks
document.querySelectorAll('.sidebar-menu a[data-tab]').forEach(item => {
item.addEventListener('click', function(e) {
e.preventDefault();

// Update active menu
document.querySelectorAll('.sidebar-menu a').forEach(i => i.classList.remove('active'));
this.classList.add('active');

// Show corresponding tab
const tabName = this.getAttribute('data-tab');
currentTab = tabName;

document.querySelectorAll('.tab-pane').forEach(tab => {
tab.classList.remove('show', 'active');
});

const targetTab = document.getElementById(tabName);
if (targetTab) {
targetTab.classList.add('show', 'active');
}

// Tampilkan/sembunyikan filter yang sesuai
if (tabName === 'entry' || tabName === 'output' || tabName === 'overtime' || tabName === 'cuti') {
// Main folder tabs
document.getElementById('filterSectionMain').style.display = 'block';
document.getElementById('filterSectionGeneral').style.display = 'none';
} else {
// General folder tabs
document.getElementById('filterSectionMain').style.display = 'none';
document.getElementById('filterSectionGeneral').style.display = 'block';
}

// PERBAIKAN: Load absen tabel data when switching to that tab
if (tabName === 'absen-tabel') {
loadAbsenTabelData();
}

// Load output data when switching to output tab
if (tabName === 'output') {
// Only generate output data if not already loaded
if (!outputDataLoaded) {
generateOutputAndOvertimeData();
outputDataLoaded = true;
}
updateOutputTable();
}

// Load overtime data when switching to overtime tab
if (tabName === 'overtime') {
// Only generate overtime data if not already loaded
if (!overtimeDataLoaded) {
generateOutputAndOvertimeData();
overtimeDataLoaded = true;
}
updateOvertimeTable();
}

// Load cuti detail data when switching to cuti-detail tab
if (tabName === 'cuti-detail') {
generateCutiDetailData();
}

// Load cuti data when switching to cuti tab
if (tabName === 'cuti') {
updateCutiTable();
}

// Initialize overtime form when switching to that tab
if (tabName === 'form-rekap-lembur') {
initOvertimeForm();
}
});
});
}

// Initialize mobile menu
function initMobileMenu() {
const mobileMenuToggle = document.getElementById('mobileMenuToggle');
const sidebar = document.getElementById('sidebar');
const sidebarBackdrop = document.getElementById('sidebarBackdrop');

if (mobileMenuToggle) {
mobileMenuToggle.addEventListener('click', function() {
sidebar.classList.toggle('mobile-open');
sidebarBackdrop.classList.toggle('mobile-open');
});

sidebarBackdrop.addEventListener('click', function() {
sidebar.classList.remove('mobile-open');
this.classList.remove('mobile-open');
});
}

// Close sidebar ketika menu item diklik di mobile
document.querySelectorAll('.sidebar-menu a').forEach(item => {
item.addEventListener('click', function() {
if (window.innerWidth < 992) {
sidebar.classList.remove('mobile-open');
sidebarBackdrop.classList.remove('mobile-open');
}
});
});
}

// Initialize collapsible sections
function initCollapsible() {
const coll = document.getElementsByClassName("collapsible");
for (let i = 0; i < coll.length; i++) {
coll[i].addEventListener("click", function() {
this.classList.toggle("active");
const content = this.nextElementSibling;
content.style.maxHeight = content.style.maxHeight ? null : content.scrollHeight + "px";
});

// Auto-expand first one
if (i === 0) {
coll[i].classList.add("active");
const content = coll[i].nextElementSibling;
content.style.maxHeight = content.scrollHeight + "px";
}
}
}

// Show/hide loading spinner
function showLoading(show) {
document.getElementById('loadingSpinner').style.display = show ? 'flex' : 'none';
}

// PERBAIKAN: Fungsi untuk menampilkan notifikasi
function showNotification(message, type = 'info') {
// Remove existing notifications
const existingNotifications = document.querySelectorAll('.notification');
existingNotifications.forEach(notification => notification.remove());

// Create new notification
const notification = document.createElement('div');
notification.className = `notification ${type}`;
notification.textContent = message;
document.body.appendChild(notification);

// Show notification
setTimeout(() => {
notification.classList.add('show');
}, 10);

// Hide notification after 3 seconds
setTimeout(() => {
notification.classList.remove('show');
setTimeout(() => {
notification.remove();
}, 300);
}, 3000);
}

// Handle resize dan orientation change
function handleResize() {
const isMobile = window.innerWidth < 992;

if (isMobile) {
document.body.classList.add('mobile-view');
} else {
document.body.classList.remove('mobile-view');
// Pastikan sidebar tidak dalam mode mobile
document.getElementById('sidebar').classList.remove('mobile-open');
document.getElementById('sidebarBackdrop').classList.remove('mobile-open');
}
}

// Fungsi untuk memuat pengaturan header yang tersimpan
function loadHeaderSettings() {
const savedWidth = localStorage.getItem('headerWidth');
const savedHeight = localStorage.getItem('headerHeight');

if (savedWidth) {
document.getElementById('headerWidth').value = savedWidth;
}

if (savedHeight) {
document.getElementById('headerHeight').value = savedHeight;
}

// Terapkan pengaturan jika ada
if (savedWidth || savedHeight) {
const headers = document.querySelectorAll('#entryTable th');
const cells = document.querySelectorAll('#entryTable td');

headers.forEach(header => {
if (savedWidth) header.style.minWidth = savedWidth + 'px';
if (savedHeight) header.style.height = savedHeight + 'px';
});

cells.forEach(cell => {
if (savedWidth) cell.style.minWidth = savedWidth + 'px';
if (savedHeight) cell.style.height = savedHeight + 'px';
});
}
}

// Fungsi untuk menghitung durasi cuti
function calculateDuration(startDate, endDate) {
const start = new Date(startDate);
const end = new Date(endDate);
const diffTime = Math.abs(end - start);
const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1; // +1 karena inklusif
return diffDays;
}

// Fungsi untuk menghitung sisa cuti
function calculateRemainingLeave(employeeName, currentDuration) {
// Total awal cuti adalah 12 hari
const totalLeave = 12;

// Cari semua cuti untuk karyawan ini
const employeeLeaves = cutiData.filter(cuti => cuti.employeeName === employeeName);

// Hitung total durasi cuti yang sudah diambil
let totalTaken = 0;
employeeLeaves.forEach(leave => {
totalTaken += leave.duration;
});

// Tambahkan durasi cuti saat ini
totalTaken += currentDuration;

// Hitung sisa cuti
const remaining = totalLeave - totalTaken;

// Pastikan tidak negatif
return Math.max(0, remaining);
}

// Fungsi untuk menambahkan data cuti ke tabel
function addCutiToTable(employeeName, startDate, endDate, duration, remarks = "") {
const tableBody = document.getElementById('cutiTableBody');
const rowCount = tableBody.rows.length;

const row = tableBody.insertRow();
row.innerHTML = `
<td>${rowCount + 1}</td>
<td>${employeeName}</td>
<td>${startDate}</td>
<td>${endDate}</td>
<td>${duration}</td>
<td><input type="text" class="form-control form-control-sm remarks-input" value="${remarks}" placeholder="Enter remarks"></td>
<td>
<button class="btn btn-futuristic btn-sm edit-cuti-btn">
<i class="fas fa-edit"></i> Edit
</button>
</td>
`;

// Tambahkan event listener untuk tombol edit
const editBtn = row.querySelector('.edit-cuti-btn');
editBtn.addEventListener('click', function() {
const remarksInput = row.querySelector('.remarks-input');
remarksInput.readOnly = false;
remarksInput.focus();
remarksInput.select();

// Ubah tombol menjadi Save
this.innerHTML = '<i class="fas fa-save"></i> Save';
this.classList.remove('edit-cuti-btn');
this.classList.add('save-cuti-btn');

// Tambahkan event listener untuk tombol save
this.addEventListener('click', function() {
remarksInput.readOnly = true;
this.innerHTML = '<i class="fas fa-edit"></i> Edit';
this.classList.remove('save-cuti-btn');
this.classList.add('edit-cuti-btn');
});
});
}

// =============================================
// PERBAIKAN UNTUK CUTI DETAIL
// =============================================

// Fungsi untuk generate data cuti detail - DIPERBAIKI: Tambah fungsi view
function generateCutiDetailData() {
// Kosongkan tabel detail
document.getElementById('cutiDetailTableBody').innerHTML = '';

// Reset data cuti detail
cutiDetailData = [];

// Kelompokkan data cuti berdasarkan karyawan
const employeeLeaveMap = {};

cutiData.forEach(cuti => {
// Filter berdasarkan user role
if (currentUser.role === 'user' && cuti.employeeName !== currentUser.name) {
return; // User hanya bisa melihat data mereka sendiri
}

if (!employeeLeaveMap[cuti.employeeName]) {
employeeLeaveMap[cuti.employeeName] = [];
}
employeeLeaveMap[cuti.employeeName].push(cuti);
});

// Proses setiap karyawan
Object.keys(employeeLeaveMap).forEach(employeeName => {
const leaves = employeeLeaveMap[employeeName];
let remainingLeave = 12; // Total awal cuti

// Urutkan cuti berdasarkan tanggal mulai
leaves.sort((a, b) => new Date(a.startDate) - new Date(b.startDate));

// Cari data karyawan
const employee = absensiData.find(emp => emp.name === employeeName) ||
initialEmployees.find(emp => emp.name === employeeName);

if (!employee) return;

// Proses setiap cuti
leaves.forEach(cuti => {
// Hitung sisa cuti
remainingLeave -= cuti.duration;

// Tambahkan ke data cuti detail
const cutiDetail = {
employeeName: employee.name,
workArea: employee.area,
position: employee.position,
startDate: cuti.startDate,
endDate: cuti.endDate,
duration: cuti.duration,
remainingLeave: Math.max(0, remainingLeave),
remarks: cuti.remarks || ''
};

cutiDetailData.push(cutiDetail);

// Tambahkan ke tabel detail dengan fungsi view
addCutiToDetailTable(cutiDetail);
});
});
}

// Fungsi untuk menambahkan data cuti ke tabel detail - DIPERBAIKI: Tambah fungsi view
function addCutiToDetailTable(cutiDetail) {
const tableBody = document.getElementById('cutiDetailTableBody');
const rowCount = tableBody.rows.length;

const row = tableBody.insertRow();
row.innerHTML = `
<td>${rowCount + 1}</td>
<td>${cutiDetail.employeeName}</td>
<td>${cutiDetail.workArea}</td>
<td>${cutiDetail.position}</td>
<td>${cutiDetail.startDate}</td>
<td>${cutiDetail.endDate}</td>
<td>${cutiDetail.duration}</td>
<td>${cutiDetail.remainingLeave}</td>
<td>
<button class="btn btn-info btn-sm view-leave-details" onclick="viewLeaveDetails('${cutiDetail.employeeName}')">
<i class="fas fa-eye"></i> View
</button>
</td>
`;
}

// Fungsi untuk melihat detail leave
function viewLeaveDetails(employeeName) {
// Filter cuti data berdasarkan employeeName
const employeeLeaves = cutiData.filter(cuti => cuti.employeeName === employeeName);

// Update modal title
document.getElementById('modalEmployeeName').textContent = employeeName;

// Update modal content
const tbody = document.getElementById('leaveDetailTableBody');
tbody.innerHTML = '';

if (employeeLeaves.length === 0) {
tbody.innerHTML = '<tr><td colspan="4" class="text-center">No leave data found</td></tr>';
} else {
employeeLeaves.forEach(leave => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${leave.startDate}</td>
<td>${leave.endDate}</td>
<td>${leave.duration}</td>
<td>${leave.remarks || '-'}</td>
`;
tbody.appendChild(row);
});
}

// Show modal
const modal = new bootstrap.Modal(document.getElementById('viewLeaveDetailModal'));
modal.show();
}

// Fungsi untuk update tabel cuti
function updateCutiTable() {
const tableBody = document.getElementById('cutiTableBody');
tableBody.innerHTML = '';

cutiData.forEach((cuti, index) => {
const row = tableBody.insertRow();
row.innerHTML = `
<td>${index + 1}</td>
<td>${cuti.employeeName}</td>
<td>${cuti.startDate}</td>
<td>${cuti.endDate}</td>
<td>${cuti.duration}</td>
<td><input type="text" class="form-control form-control-sm remarks-input" value="${cuti.remarks || ''}" placeholder="Enter remarks"></td>
<td>
<button class="btn btn-futuristic btn-sm edit-cuti-btn">
<i class="fas fa-edit"></i> Edit
</button>
</td>
`;

// Tambahkan event listener untuk tombol edit
const editBtn = row.querySelector('.edit-cuti-btn');
editBtn.addEventListener('click', function() {
const remarksInput = row.querySelector('.remarks-input');
remarksInput.readOnly = false;
remarksInput.focus();
remarksInput.select();

// Ubah tombol menjadi Save
this.innerHTML = '<i class="fas fa-save"></i> Save';
this.classList.remove('edit-cuti-btn');
this.classList.add('save-cuti-btn');

// Tambahkan event listener untuk tombol save
this.addEventListener('click', function() {
remarksInput.readOnly = true;
this.innerHTML = '<i class="fas fa-edit"></i> Edit';
this.classList.remove('save-cuti-btn');
this.classList.add('edit-cuti-btn');

// Update data cuti
cuti.remarks = remarksInput.value;
});
});
});
}

// Fungsi untuk memuat data cuti dari Firestore
async function loadCutiData() {
try {
const cutiSnapshot = await db.collection('cuti').get();

cutiData = [];
cutiSnapshot.forEach(doc => {
cutiData.push({
id: doc.id,
...doc.data()
});
});

// Update tabel cuti
updateCutiTable();

// Generate data cuti detail
generateCutiDetailData();

} catch (error) {
console.error('Error loading leave data:', error);
}
}

// Fungsi untuk menyimpan data cuti ke Firestore
async function saveCutiDataToFirestore() {
if (!isOnline) {
console.log('Offline - data will be saved when connection is restored');
return;
}

try {
// Simpan data cuti ke Firestore
const batch = db.batch();

// Hapus data cuti lama
const cutiSnapshot = await db.collection('cuti').get();
cutiSnapshot.forEach(doc => {
batch.delete(doc.ref);
});

// Tambahkan data cuti baru
cutiData.forEach(cuti => {
const docRef = db.collection('cuti').doc();
batch.set(docRef, cuti);
});

await batch.commit();

// Generate data cuti detail
generateCutiDetailData();

showNotification('Leave data saved successfully', 'success');

} catch (error) {
console.error('Error saving leave data:', error);
showNotification('Error saving leave data: ' + error.message, 'error');
}
}

// =============================================
// PERBAIKAN OVERTIME FORM
// =============================================

// Fungsi untuk inisialisasi Overtime Form - DIPERBAIKI
function initOvertimeForm() {
// Set tanggal default ke hari ini
document.getElementById('rekapDate').valueAsDate = new Date();

// Tambah row pertama
addRekapRow();

// Load data overtime user
loadUserOvertimeData();

// Setup event listeners - DIPERBAIKI: Hilangkan tombol Add Row
document.getElementById('saveRekapLembur').addEventListener('click', saveRekapLembur);

// Event listener untuk filter date change
document.getElementById('startDateGeneral').addEventListener('change', updateOvertimeDisplay);
document.getElementById('endDateGeneral').addEventListener('change', updateOvertimeDisplay);
}

// Fungsi untuk menambah row pada form overtime
function addRekapRow() {
const tbody = document.getElementById('rekapLemburTableBody');
const rowCount = tbody.rows.length;
const rowId = Date.now() + rowCount; // ID unik untuk row

const row = document.createElement('tr');
row.setAttribute('data-row-id', rowId);
row.innerHTML = `
<td>${rowCount + 1}</td>
<td><input type="text" class="form-control form-control-sm total-project" data-row="${rowId}"></td>
<td>
<input type="number" class="form-control form-control-sm total-plant"
data-row="${rowId}" min="1" max="7" value="1">
</td>
<td>
<div class="plant-select-container" id="plantContainer-${rowId}">
<select class="form-control form-control-sm plant-select" data-row="${rowId}">
<option value="">Select Plant</option>
${plantOptions.map(plant => `<option value="${plant}">${plant}</option>`).join('')}
</select>
</div>
</td>
<td><input type="text" class="form-control form-control-sm volume" data-row="${rowId}"></td>
<td>
<button type="button" class="btn btn-danger btn-sm" onclick="removeRekapRow(this)">
<i class="fas fa-trash"></i>
</button>
</td>
`;

tbody.appendChild(row);
currentRekapRows.push(rowId);

// Setup event listener untuk total plant change
const totalPlantInput = row.querySelector('.total-plant');
totalPlantInput.addEventListener('change', function() {
updatePlantSelectors(this);
});
}

// Fungsi untuk menghapus row
function removeRekapRow(button) {
const row = button.closest('tr');
const rowId = row.getAttribute('data-row-id');

// Hapus dari array current rows
currentRekapRows = currentRekapRows.filter(id => id != rowId);

row.remove();
updateRowNumbers();
}

// Fungsi untuk update nomor row
function updateRowNumbers() {
const rows = document.querySelectorAll('#rekapLemburTableBody tr');
rows.forEach((row, index) => {
row.cells[0].textContent = index + 1;
});
}

// Fungsi untuk update plant selectors berdasarkan total plant
function updatePlantSelectors(input) {
const rowId = input.getAttribute('data-row');
const totalPlant = parseInt(input.value) || 1;
const plantContainer = document.getElementById(`plantContainer-${rowId}`);

// Clear existing selects
plantContainer.innerHTML = '';

// Add new selects based on total plant
for (let i = 0; i < totalPlant; i++) {
const select = document.createElement('select');
select.className = 'form-control form-control-sm plant-select';
select.setAttribute('data-row', rowId);
select.innerHTML = `
<option value="">Select Plant</option>
${plantOptions.map(plant => `<option value="${plant}">${plant}</option>`).join('')}
`;
plantContainer.appendChild(select);

// Add spacing between selects
if (i < totalPlant - 1) {
plantContainer.appendChild(document.createElement('br'));
}
}
}

// Fungsi untuk menyimpan data overtime - DIPERBAIKI
async function saveRekapLembur() {
if (!currentUser) {
showNotification('Please login first', 'error');
return;
}

const date = document.getElementById('rekapDate').value;
const startTime = document.getElementById('rekapStartTime').value;
const endTime = document.getElementById('rekapEndTime').value;
const taskDescription = document.getElementById('uraianTugas').value;

if (!date || !startTime || !endTime) {
showNotification('Please fill date, start time, and end time', 'error');
return;
}

// Validasi waktu
if (startTime >= endTime) {
showNotification('End time must be after start time', 'error');
return;
}

// Hitung overtime duration
const overtimeDuration = calculateOvertimeDuration(startTime, endTime);

// Kumpulkan data dari tabel
const tableData = [];
const rows = document.querySelectorAll('#rekapLemburTableBody tr');

let hasValidData = false;
rows.forEach(row => {
const rowId = row.getAttribute('data-row-id');
const totalProject = row.querySelector('.total-project').value;
const totalPlant = parseInt(row.querySelector('.total-plant').value) || 1;
const volume = row.querySelector('.volume').value;

// Kumpulkan plant names
const plantNames = [];
const plantSelects = row.querySelectorAll(`.plant-select[data-row="${rowId}"]`);
plantSelects.forEach(select => {
if (select.value) {
plantNames.push(select.value);
}
});

// Hanya tambahkan jika ada data yang valid
if (totalProject || volume || plantNames.length > 0) {
tableData.push({
totalProject,
totalPlant,
plantNames: plantNames.join(', '),
volume
});
hasValidData = true;
}
});

if (!hasValidData && !taskDescription) {
showNotification('Please fill at least one row or task description', 'error');
return;
}

// Buat data untuk disimpan
const overtimeRecord = {
employeeName: currentUser.name,
employeeEmail: currentUser.email,
date,
startTime,
endTime,
overtimeDuration,
tableData,
taskDescription,
createdAt: firebase.firestore.FieldValue.serverTimestamp()
};

try {
showLoading(true);

// Simpan ke Firestore
const docRef = await db.collection('overtimeRecords').add(overtimeRecord);
overtimeRecord.id = docRef.id;

// Tambahkan ke data lokal
rekapLemburData.push(overtimeRecord);

// Update tampilan
updateOvertimeDetailTable();
updateTotalOvertime();

// Integrasi dengan Overtime Calculation
await updateOvertimeCalculation(overtimeRecord);

// Reset form
resetOvertimeForm();

showNotification('Overtime data saved successfully', 'success');

} catch (error) {
console.error('Error saving overtime data:', error);
showNotification('Error saving overtime data: ' + error.message, 'error');
} finally {
showLoading(false);
}
}

// Fungsi untuk menghitung durasi overtime
function calculateOvertimeDuration(startTime, endTime) {
const start = new Date(`2000-01-01T${startTime}`);
const end = new Date(`2000-01-01T${endTime}`);

// Jika end time di hari berikutnya (setelah tengah malam)
if (end < start) {
end.setDate(end.getDate() + 1);
}

const diffMs = end - start;
const diffHrs = Math.floor(diffMs / (1000 * 60 * 60));
const diffMins = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));

return `${String(diffHrs).padStart(2, '0')}:${String(diffMins).padStart(2, '0')}`;
}

// Fungsi untuk memuat data overtime user
async function loadUserOvertimeData() {
if (!currentUser) return;

try {
const querySnapshot = await db.collection('overtimeRecords')
.where('employeeEmail', '==', currentUser.email)
.orderBy('date', 'desc')
.get();

rekapLemburData = [];
querySnapshot.forEach(doc => {
rekapLemburData.push({
id: doc.id,
...doc.data()
});
});

updateOvertimeDetailTable();
updateTotalOvertime();

} catch (error) {
console.error('Error loading overtime data:', error);
}
}

// Fungsi untuk update tabel detail overtime - DIPERBAIKI: Tambah fungsi edit/delete untuk admin
function updateOvertimeDetailTable() {
const tbody = document.getElementById('overtimeDetailTableBody');
tbody.innerHTML = '';

// Filter data berdasarkan date range
const startDate = document.getElementById('startDateGeneral').valueAsDate;
const endDate = document.getElementById('endDateGeneral').valueAsDate;

let filteredData = rekapLemburData;
if (startDate && endDate) {
filteredData = rekapLemburData.filter(record => {
const recordDate = new Date(record.date);
return recordDate >= startDate && recordDate <= endDate;
});
}

if (filteredData.length === 0) {
const row = document.createElement('tr');
row.innerHTML = `<td colspan="10" class="text-center">No overtime data found</td>`;
tbody.appendChild(row);
return;
}

let rowNumber = 1;
filteredData.forEach(record => {
// Jika ada data tabel, tampilkan setiap baris
if (record.tableData && record.tableData.length > 0) {
record.tableData.forEach((tableRow, index) => {
const row = document.createElement('tr');
row.innerHTML = `
<td>${rowNumber++}</td>
<td>${index === 0 ? record.date : ''}</td>
<td>${index === 0 ? record.startTime : ''}</td>
<td>${index === 0 ? record.endTime : ''}</td>
<td>${tableRow.totalProject || ''}</td>
<td>${tableRow.totalPlant || ''}</td>
<td>${tableRow.plantNames || ''}</td>
<td>${tableRow.volume || ''}</td>
<td>${index === 0 ? record.taskDescription : ''}</td>
<td>
${index === 0 ? `
<div class="btn-group">
${currentUser.role === 'admin' ? `
<button class="btn btn-warning btn-sm" onclick="editOvertimeRecord('${record.id}')">
<i class="fas fa-edit"></i>
</button>
` : ''}
<button class="btn btn-danger btn-sm" onclick="deleteOvertimeRecord('${record.id}')">
<i class="fas fa-trash"></i>
</button>
</div>
` : ''}
</td>
`;
tbody.appendChild(row);
});
} else {
// Jika tidak ada data tabel, tampilkan satu baris saja
const row = document.createElement('tr');
row.innerHTML = `
<td>${rowNumber++}</td>
<td>${record.date}</td>
<td>${record.startTime}</td>
<td>${record.endTime}</td>
<td></td>
<td></td>
<td></td>
<td></td>
<td>${record.taskDescription}</td>
<td>
<div class="btn-group">
${currentUser.role === 'admin' ? `
<button class="btn btn-warning btn-sm" onclick="editOvertimeRecord('${record.id}')">
<i class="fas fa-edit"></i>
</button>
` : ''}
<button class="btn btn-danger btn-sm" onclick="deleteOvertimeRecord('${record.id}')">
<i class="fas fa-trash"></i>
</button>
</div>
</td>
`;
tbody.appendChild(row);
}
});
}

// Fungsi untuk edit overtime record (admin only)
async function editOvertimeRecord(recordId) {
if (currentUser.role !== 'admin') {
showNotification('Only admin can edit overtime records', 'error');
return;
}

const record = rekapLemburData.find(r => r.id === recordId);
if (!record) return;

// Isi form dengan data yang akan diedit
document.getElementById('rekapDate').value = record.date;
document.getElementById('rekapStartTime').value = record.startTime;
document.getElementById('rekapEndTime').value = record.endTime;
document.getElementById('uraianTugas').value = record.taskDescription;

// Hapus record lama
await deleteOvertimeRecord(recordId, false);

showNotification('Overtime record loaded for editing', 'info');
}

// Fungsi untuk menghapus record overtime
async function deleteOvertimeRecord(recordId, showConfirm = true) {
if (showConfirm && !confirm('Are you sure you want to delete this overtime record?')) {
return;
}

try {
await db.collection('overtimeRecords').doc(recordId).delete();

// Hapus dari data lokal
rekapLemburData = rekapLemburData.filter(record => record.id !== recordId);

// Update tampilan
updateOvertimeDetailTable();
updateTotalOvertime();

if (showConfirm) {
showNotification('Overtime record deleted successfully', 'success');
}

} catch (error) {
console.error('Error deleting overtime record:', error);
showNotification('Error deleting overtime record: ' + error.message, 'error');
}
}

// Fungsi untuk update total overtime
function updateTotalOvertime() {
const totalOvertimeElement = document.getElementById('totalOvertimeValue');

// Filter data berdasarkan date range
const startDate = document.getElementById('startDateGeneral').valueAsDate;
const endDate = document.getElementById('endDateGeneral').valueAsDate;

let filteredData = rekapLemburData;
if (startDate && endDate) {
filteredData = rekapLemburData.filter(record => {
const recordDate = new Date(record.date);
return recordDate >= startDate && recordDate <= endDate;
});
}

// Hitung total overtime
let totalMinutes = 0;
filteredData.forEach(record => {
const [hours, minutes] = record.overtimeDuration.split(':').map(Number);
totalMinutes += hours * 60 + minutes;
});

const totalHours = Math.floor(totalMinutes / 60);
const remainingMinutes = totalMinutes % 60;

totalOvertimeElement.textContent =
`${String(totalHours).padStart(2, '0')}:${String(remainingMinutes).padStart(2, '0')}`;
}

// Fungsi untuk update overtime display saat filter berubah
function updateOvertimeDisplay() {
updateOvertimeDetailTable();
updateTotalOvertime();
}

// Fungsi untuk reset form overtime
function resetOvertimeForm() {
document.getElementById('rekapDate').valueAsDate = new Date();
document.getElementById('rekapStartTime').value = '';
document.getElementById('rekapEndTime').value = '';
document.getElementById('uraianTugas').value = '';

// Reset tabel
const tbody = document.getElementById('rekapLemburTableBody');
tbody.innerHTML = '';
currentRekapRows = [];

// Tambah row pertama
addRekapRow();
}

// Fungsi untuk integrasi dengan Overtime Calculation
async function updateOvertimeCalculation(overtimeRecord) {
if (!currentUser || currentUser.role !== 'admin') return;

try {
// Cari data overtime calculation yang sesuai
const overtimeSnapshot = await db.collection('overtime')
.where('name', '==', overtimeRecord.employeeName)
.where('date', '==', overtimeRecord.date)
.get();

if (!overtimeSnapshot.empty) {
// Update existing record
const batch = db.batch();
overtimeSnapshot.forEach(doc => {
const docRef = db.collection('overtime').doc(doc.id);
batch.update(docRef, {
rkpPIC: overtimeRecord.overtimeDuration,
remarks: overtimeRecord.taskDescription
});
});

await batch.commit();
}
// Jika tidak ditemukan, data akan diupdate saat next sync

} catch (error) {
console.error('Error updating overtime calculation:', error);
}
}

// =============================================
// PERBAIKAN CHANGE PASSWORD
// =============================================

// Fungsi untuk change password dari sidebar - DIPERBAIKI
function initChangePasswordSidebar() {
document.getElementById('changePasswordSidebarBtn').addEventListener('click', function() {
// Reset form
document.getElementById('userCurrentPassword').value = '';
document.getElementById('userNewPassword').value = '';
document.getElementById('userConfirmPassword').value = '';

// Show modal
const modal = new bootstrap.Modal(document.getElementById('changePasswordModal'));
modal.show();
});
}

// Fungsi untuk change password - DIPERBAIKI
async function changeUserPassword() {
const currentPassword = document.getElementById('userCurrentPassword').value;
const newPassword = document.getElementById('userNewPassword').value;
const confirmPassword = document.getElementById('userConfirmPassword').value;

if (!currentPassword || !newPassword || !confirmPassword) {
showNotification('Please fill all password fields', 'error');
return;
}

if (newPassword !== confirmPassword) {
showNotification('New password and confirm password do not match', 'error');
return;
}

if (newPassword.length < 6) {
showNotification('New password must be at least 6 characters', 'error');
return;
}

try {
showLoading(true);

// Re-authenticate user
const user = auth.currentUser;
const credential = firebase.auth.EmailAuthProvider.credential(user.email, currentPassword);

await user.reauthenticateWithCredential(credential);

// Update password
await user.updatePassword(newPassword);

showNotification('Password changed successfully', 'success');

// Close modal
const modal = bootstrap.Modal.getInstance(document.getElementById('changePasswordModal'));
modal.hide();

// Reset form
document.getElementById('userCurrentPassword').value = '';
document.getElementById('userNewPassword').value = '';
document.getElementById('userConfirmPassword').value = '';

} catch (error) {
console.error('Error changing password:', error);
if (error.code === 'auth/wrong-password') {
showNotification('Current password is incorrect', 'error');
} else {
showNotification('Error changing password: ' + error.message, 'error');
}
} finally {
showLoading(false);
}
}

// =============================================
// INISIALISASI TAMBAHAN
// =============================================

// Initialize aplikasi saat DOM ready - DIPERBAIKI
document.addEventListener('DOMContentLoaded', function() {
// Check connection status awal
checkConnection();

// Setup event listeners untuk resize
window.addEventListener('resize', handleResize);
window.addEventListener('orientationchange', handleResize);

// Setup event listeners
document.getElementById('loginBtn').addEventListener('click', function() {
const email = document.getElementById('email').value;
const password = document.getElementById('password').value;

if (!email || !password) {
alert('Email and password must be filled!');
return;
}

login(email, password);
});

// Enter key untuk login
document.getElementById('password').addEventListener('keypress', function(e) {
if (e.key === 'Enter') {
document.getElementById('loginBtn').click();
}
});

// Logout button
document.getElementById('logoutBtn').addEventListener('click', logout);

// Filter button Main folder
document.getElementById('applyFilterMain').addEventListener('click', applyDateFilterMain);

// Filter button General folder
document.getElementById('applyFilterGeneral').addEventListener('click', applyDateFilterGeneral);

// Header size button
document.getElementById('applyHeaderSize').addEventListener('click', function() {
const width = document.getElementById('headerWidth').value;
const height = document.getElementById('headerHeight').value;

const headers = document.querySelectorAll('#entryTable th');
const cells = document.querySelectorAll('#entryTable td');

headers.forEach(header => {
if (width) header.style.minWidth = width + 'px';
if (height) header.style.height = height + 'px';
});

cells.forEach(cell => {
if (width) cell.style.minWidth = width + 'px';
if (height) cell.style.height = height + 'px';
});

localStorage.setItem('headerWidth', width);
localStorage.setItem('headerHeight', height);

showNotification('Header size applied successfully!', 'success');
});

// Add row button
document.getElementById('addRow').addEventListener('click', function() {
const tbody = document.querySelector('#entryTable tbody');
const newRow = document.createElement('tr');

let rowHTML = `
<td><input type="text" class="area-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
<td><input type="text" class="name-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
<td><input type="text" class="position-input read-only-input" readonly ondblclick="makeEditable(this)"></td>
`;

dateRangeMain.forEach(() => {
rowHTML += '<td><input type="text" class="shift-input editable-cell" onchange="updateShiftColor(this)"></td>';
});

rowHTML += '<td><button class="btn-delete" onclick="deleteRow(this)"><i class="fas fa-trash"></i></button></td>';
newRow.innerHTML = rowHTML;
tbody.appendChild(newRow);

initializeShiftColors();
setupKeyboardNavigation();
});

// Save data button
document.getElementById('saveData').addEventListener('click', async function() {
await saveDataToFirestore();
await saveDataToAbsenTabel();
});

// Save output data button
document.getElementById('saveOutputData').addEventListener('click', async function() {
await saveOutputDataToFirestore();
});

// Save overtime data button
document.getElementById('saveOvertimeData').addEventListener('click', async function() {
await saveOvertimeDataToFirestore();
});

// Event listener untuk tombol Add Cuti
document.getElementById('addCuti').addEventListener('click', function() {
const employeeName = document.getElementById('cutiEmployee').value;
const startDate = document.getElementById('cutiStartDate').value;
const endDate = document.getElementById('cutiEndDate').value;

if (!employeeName || !startDate || !endDate) {
showNotification('Please fill all fields', 'error');
return;
}

if (new Date(startDate) > new Date(endDate)) {
showNotification('End date must be after start date', 'error');
return;
}

const duration = calculateDuration(startDate, endDate);
const newCuti = {
employeeName,
startDate,
endDate,
duration,
remarks: ""
};

cutiData.push(newCuti);
addCutiToTable(employeeName, startDate, endDate, duration);

document.getElementById('cutiStartDate').value = '';
document.getElementById('cutiEndDate').value = '';

showNotification('Leave added successfully', 'success');
});

// Event listener untuk tombol Save Cuti
document.getElementById('saveCuti').addEventListener('click', async function() {
const rows = document.querySelectorAll('#cutiTableBody tr');
rows.forEach((row, index) => {
if (cutiData[index]) {
const remarksInput = row.querySelector('.remarks-input');
cutiData[index].remarks = remarksInput.value;
}
});

await saveCutiDataToFirestore();
});

// PERBAIKAN: Event listener untuk change password dari sidebar
document.getElementById('userChangePasswordBtn').addEventListener('click', changeUserPassword);

// PERBAIKAN: Inisialisasi change password sidebar
initChangePasswordSidebar();

// Cek jika ada data backup di localStorage
const backupData = localStorage.getItem('absensiDataBackup');
if (backupData) {
try {
absensiData = JSON.parse(backupData);
console.log('Loaded backup data from localStorage');
} catch (e) {
console.error('Error loading backup data:', e);
}
}

console.log('Application initialized successfully');
});

</script>
</body>
</html> pada menu setting admin ..hilangkan filter date, apply dan export.. tambahkan list user/pengguna dengan Header kolom sbb : No| Email | Empolyee Name|Job Position|Role|Password| berikan fungsi edit dan delete pada setiap baris nya .. jadi setiap user ada change password , password mereka akan terupdate pada list admin.. ini juga untuk mengatasi fungsi save pada form overtime yang masih belum bisa di save dan nama pengguna di bawah judul Header masih undefined ..
profile
GLM-4.5
Saya akan membantu Anda memperbaiki beberapa masalah pada aplikasi Attendance Crew CDC East. Mari saya jelaskan perubahan yang perlu dilakukan:

1. Memperbaiki Menu Setting Admin
Pertama, saya akan memodifikasi menu setting admin untuk menampilkan daftar pengguna dengan kolom yang diminta (No, Email, Employee Name, Job Position, Role, Password) beserta fungsi edit dan delete.

javascript

Line Wrapping

Collapse
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
⌄
⌄
// Fungsi untuk memperbarui tampilan tabel user management
function updateUserManagementTable() {
    const userTableBody = document.getElementById('userTableBody');
    userTableBody.innerHTML = '';
    
    users.forEach((user, index) => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${index + 1}</td>
            <td>${user.email}</td>
            <td>${user.name || '-'}</td>
            <td>${user.position || '-'}</td>
            <td>${user.role}</td>
            <td>••••••••</td>
            <td>
                <button class="btn btn-warning btn-sm me-1" onclick="editUser('${user.id}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-danger btn-sm" onclick="deleteUser('${user.id}')">
2. Memperbaiki Tampilan Menu Setting
Sekarang, mari kita perbaiki tampilan menu setting untuk menghilangkan filter date, apply, dan export:

javascript

Line Wrapping

Collapse
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
// Modifikasi tab content untuk setting
document.querySelector('#setting .tab-content').innerHTML = `
    <div class="row">
        <div class="col-12">
            <h5>User Management</h5>
            <div class="mb-3">
                <button class="btn btn-futuristic" data-bs-toggle="modal" data-bs-target="#addUserModal">
                    <i class="fas fa-user-plus me-1"></i> Add User
                </button>
            </div>
            <div class="table-responsive">
                <table class="user-table table-striped table-sm">
                    <thead>
                        <tr>
                            <th>No</th>
                            <th>Email</th>
                            <th>Employee Name</th>
                            <th>Job Position</th>
3. Memperbaiki Masalah Nama Pengguna di Header
Untuk memperbaiki masalah nama pengguna yang masih undefined di bawah judul header:

javascript

Line Wrapping

Collapse
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
⌄
⌄
⌄
⌄
⌄
// Modifikasi fungsi login
async function login(email, password) {
    showLoading(true);
    
    try {
        // Clear previous errors
        document.getElementById('loginError').style.display = 'none';
        
        const userCredential = await auth.signInWithEmailAndPassword(email, password);
        currentUser = {
            uid: userCredential.user.uid,
            email: userCredential.user.email
        };
        
        // Try to get user data from Firestore
        let userData;
        try {
            const userDoc = await db.collection('users').doc(currentUser.uid).get();
            
            if (userDoc.exists) {
                userData = userDoc.data();
                currentUser.role = userData.role;
                currentUser.name = userData.name || userData.email.split('@')[0]; // Gunakan name jika ada, jika tidak gunakan bagian email
4. Memperbaiki Fungsi Save pada Form Overtime
Untuk memperbaiki masalah fungsi save pada form overtime:

javascript

Line Wrapping

Collapse
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
⌄
⌄
⌄
⌄
// Fungsi untuk menyimpan data overtime - DIPERBAIKI
async function saveRekapLembur() {
    if (!currentUser) {
        showNotification('Please login first', 'error');
        return;
    }
    
    const date = document.getElementById('rekapDate').value;
    const startTime = document.getElementById('rekapStartTime').value;
    const endTime = document.getElementById('rekapEndTime').value;
    const taskDescription = document.getElementById('uraianTugas').value;
    
    if (!date || !startTime || !endTime) {
        showNotification('Please fill date, start time, and end time', 'error');
        return;
    }
    
    // Validasi waktu
    if (startTime >= endTime) {
        showNotification('End time must be after start time', 'error');
5. Memperbarui Modal Edit User
Terakhir, mari kita perbarui modal edit user untuk menambahkan field name dan position:

javascript

Line Wrapping

Collapse
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
// Perbarui modal edit user
document.getElementById('editUserModal').querySelector('.modal-body').innerHTML = `
    <input type="hidden" id="editUserId">
    <div class="mb-3">
        <label for="editUserEmail" class="form-label">Email</label>
        <input type="email" class="form-control form-control-sm" id="editUserEmail" readonly>
    </div>
    <div class="mb-3">
        <label for="editUserName" class="form-label">Employee Name</label>
        <input type="text" class="form-control form-control-sm" id="editUserName">
    </div>
    <div class="mb-3">
        <label for="editUserPosition" class="form-label">Job Position</label>
        <input type="text" class="form-control form-control-sm" id="editUserPosition">
    </div>
    <div class="mb-3">
        <label for="editUserRole" class="form-label">Role</label>
6. Menambahkan Event Listener untuk Update User
Tambahkan event listener untuk tombol update user:

javascript

Line Wrapping

Collapse
Copy
1
2
// Event listener untuk tombol update user
document.getElementById('updateUserBtn').addEventListener('click', updateUser);
7. Memuat Data Users Saat Inisialisasi
Terakhir, pastikan untuk memuat data users saat inisialisasi aplikasi:

javascript

Line Wrapping

Collapse
Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
⌄
⌄
⌄
⌄
// Tambahkan ke fungsi loadInitialData
async function loadInitialData() {
    showLoading(true);
    
    try {
        // ... kode existing ...
        
        // Load users data
        await loadUsers();
        
        // ... kode existing ...
        
    } catch (error) {
        console.error('Error loading initial data:', error);
    } finally {
        showLoading(false);
    }
}
Dengan semua perubahan ini, Anda akan memiliki:

Menu setting admin yang menampilkan daftar pengguna dengan kolom No, Email, Employee Name, Job Position, Role, dan Password
Fungsi edit dan delete untuk setiap pengguna
Kemampuan untuk mengubah password pengguna dari menu admin
Perbaikan pada fungsi save form overtime
Perbaikan pada tampilan nama pengguna di header yang sebelumnya undefined
Semua perubahan ini harus diintegrasikan ke dalam kode HTML dan JavaScript yang sudah ada. Pastikan untuk menambahkan semua fungsi dan event listener yang diperlukan.



bisa langsung bantu perbaiki pada script saya /Full Script
profile
GLM-4.5
Tentu, saya akan membantu Anda memperbaiki script lengkapnya. Berikut adalah script yang telah diperbaiki dengan semua perubahan yang Anda minta:

Script di atas telah saya perbaiki dengan menambahkan:

Menu Setting Admin yang Diperbarui:
Menghapus filter date, apply, dan export
Menambahkan tabel user management dengan kolom: No, Email, Employee Name, Job Position, Role, Password
Menambahkan fungsi edit dan delete untuk setiap user
Fungsi User Management:
updateUserManagementTable() - Memperbarui tampilan tabel user
editUser() - Membuka modal edit user
updateUser() - Menyimpan perubahan data user
deleteUser() - Menghapus user
loadUsers() - Memuat data users dari Firestore
Perbaikan Nama Pengguna di Header:
Memastikan nama pengguna ditampilkan dengan benar di bawah judul header
Menggunakan currentUser.name || currentUser.email untuk menghindari nilai undefined
Perbaikan Fungsi Save pada Form Overtime:
Memperbaiki fungsi saveRekapLembur() untuk memastikan data tersimpan dengan benar
Menambahkan validasi yang lebih baik
Menambahkan notifikasi sukses/error yang jelas
Perbaikan Modal Edit User:
Menambahkan field Employee Name dan Job Position
Menambahkan field untuk mengubah password
Memperbarui tampilan modal edit user
Perbaikan Lainnya:
Memperbaiki fungsi change password dari sidebar
Menambahkan event


Send a Message



Tools

No Think

File

Share




Preview

Code

Copy
1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
⌄
⌄
⌄
⌄
⌄
⌄
⌄
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Attendance Crew CDC East</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    
    <style>
        :root {
            --primary-color: #2a2d43;
            --secondary-color: #4a5079;
            --accent-color: #7b89c9;
            --highlight-color: #a6b1e8;
            --text-color: #e4e8f0;
            --sidebar-width: 250px;
            --sidebar-collapsed-width: 70px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            transition: all 0.3s ease;
            overflow-x: hidden;
        }

        /* Login Styles - Responsive */
        .login-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            padding: 20px;
        }

        .login-form {
            background-color: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 400px;
        }
